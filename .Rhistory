mutate(nHighKeto20 = n()) %>%
distinct(FarmNo, CowId, Lactation) #3028 obs of 4 variable
##########################################
# Number of times BHB>0.08 within 20 DFC #
##########################################
df.highketo.20d <- df.dur1_20 %>%
filter(BHBraw >= 0.08) %>% #21443 obs of 11 variables
group_by(FarmNo, CowId, Lactation) %>%
mutate(nHighKeto20 = n()) %>%
distinct(FarmNo, CowId, Lactation, nHighKeto20) #3028 obs of 4 variable
df.keto4 <- merge(df.keto3, df.highketo.20d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F)
View(df.keto4)
##############################
# Ketosis data within 20 DFC #
##############################
# Filter out all the measurements after 20 DIM
df.avg20d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(Lactation, rDFC, BHBraw) %>%
filter(rDFC <=20) %>%
mutate(AvgKeto20 = mean(BHBraw, na.rm = TRUE)) %>%
distinct(FarmNo, CowId, Lactation, AvgKeto20) #5068 obs of 4 variables
##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_20 <- data.frame()
df.dur1_20 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 20) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_20DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_20DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto20_all = mean(BHBraw, na.rm = TRUE),
MaxDFC = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours20 = sum(Hours_20DFC, na.rm=TRUE)) #91725 obs of 11 variables
df.dur20 <- df.dur1_20 %>%
distinct(FarmNo, CowId, Lactation, KetoHours20, MedianSampleTime, AvgKeto20_all) #5068 obs of 6 variables
# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur20 %>%
filter(FarmNo == 1002, CowId == 581)
## Strictness of the days of measurement
# Select all cows that have the maxDFC above 10
df.avg10_20d <- df.dur1_20 %>%
filter(MaxDFC >= 10) %>% #91594 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto20_all, KetoHours20, MedianSampleTime) #5035 obs of 6 variables
colnames(df.avg10_20d)[colnames(df.avg10_20d) == "AvgKeto20_all"] <- "AvgKeto20_atleast10"
# Only select cows that have the maxDFC = 20
df.avgmax20d <- df.dur1_20 %>%
filter(MaxDFC == 20) %>% #83951 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto20_all, KetoHours20, MedianSampleTime) #4524 obs of 6 variables
colnames(df.avgmax20d)[colnames(df.avgmax20d) == "AvgKeto20_all"] <- "AvgKeto20_atleast20"
# Duplicated lactatrions cows exist?
df.test <- df.avgmax20d %>%
filter(FarmNo == 1002, CowId == 581)
# Merge data (Average 20DFC KETOSIS)
df.keto1 <- merge(df.avg10_20d, df.avgmax20d, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours20'), all.x=TRUE, all.y=TRUE) #5035 obs of 7 variables
df.keto2 <- merge(df.dur20, df.keto1, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours20'), all.x=TRUE, all.y=TRUE) #5068 ofbs of 8 variables
######################################################
# When did the cow has the highest BHB within 20DFC? #
######################################################
df.max20d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(rDFC, BHBraw) %>%
filter(rDFC <= 20) %>% #91725 obs of 5 variables
filter(BHBraw == max(BHBraw)) #5105 obs of 5 variables
names(df.max20d.all)[names(df.max20d.all) == "BHBraw"] <- "MaxKeto20"
names(df.max20d.all)[names(df.max20d.all) == "rDFC"] <- "MaxKetoDFC20"
df.keto3 <- merge(df.keto2, df.max20d.all, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 10 variables
##########################################
# Number of times BHB>0.08 within 20 DFC #
##########################################
df.highketo.20d <- df.dur1_20 %>%
filter(BHBraw >= 0.08) %>% #21443 obs of 11 variables
group_by(FarmNo, CowId, Lactation) %>%
mutate(nHighKeto20 = n()) %>%
distinct(FarmNo, CowId, Lactation, nHighKeto20) #3028 obs of 4 variables
df.keto4 <- merge(df.keto3, df.highketo.20d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 11 variables
##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_60 <- data.frame()
df.dur1_60 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 60) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_60DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_60DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto60_all = mean(BHBraw, na.rm = TRUE),
MaxDFC = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours60 = sum(Hours_60DFC, na.rm=TRUE)) #91725 obs of 11 variables
df.dur1_60 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 60) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_60DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_60DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto60_all = mean(BHBraw, na.rm = TRUE),
MaxDFC = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours60 = sum(Hours_60DFC, na.rm=TRUE)) #91725 obs of 11 variables
df.dur60 <- df.dur1_60 %>%
distinct(FarmNo, CowId, Lactation, KetoHours60, MedianSampleTime, AvgKeto60_all) #5068 obs of 6 variables
##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_60 <- data.frame()
df.dur1_60 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 60) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_60DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_60DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto60_all = mean(BHBraw, na.rm = TRUE),
MaxDFC = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours60 = sum(Hours_60DFC, na.rm=TRUE)) #91725 obs of 11 variables
df.dur60 <- df.dur1_60 %>%
distinct(FarmNo, CowId, Lactation, KetoHours60, MedianSampleTime, AvgKeto60_all) #5068 obs of 6 variables
# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur60 %>%
filter(FarmNo == 1002, CowId == 581)
View(df.test)
##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_60 <- data.frame()
df.dur1_60 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 60) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_60DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_60DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto60_all = mean(BHBraw, na.rm = TRUE),
MaxDFC60 = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours60 = sum(Hours_60DFC, na.rm=TRUE)) #159632 obs of 11 variables
df.dur60 <- df.dur1_60 %>%
distinct(FarmNo, CowId, Lactation, KetoHours60, MedianSampleTime, AvgKeto60_all) #5107 obs of 6 variables
# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur60 %>%
filter(FarmNo == 1002, CowId == 581)
View(df.test)
View(df.dur1_60)
## Strictness of the days of measurement
# Select all cows that have the maxDFC above 10
df.avg10_60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 10) #%>% #91594 obs of 11 variables
## Strictness of the days of measurement
# Select all cows that have the maxDFC above 10
df.avg10_60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 10) %>% #159526 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto60_all, KetoHours60, MedianSampleTime) #5035 obs of 6 variables
colnames(df.avg10_60d)[colnames(df.avg10_60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast10"
# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
filter(MaxDFC >= 30) #%>% #83951 obs of 11 variables
# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 30) #%>% #83951 obs of 11 variables
# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 30) %>% #158279 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto60_all, KetoHours60, MedianSampleTime) #4524 obs of 6 variables
colnames(df.avgmax60d)[colnames(df.avgmax60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast30"
# Duplicated lactatrions cows exist?
df.test <- df.avgmax60d %>%
filter(FarmNo == 1002, CowId == 581)
View(df.test)
View(df.avgmax60d)
# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 30) %>% #158279 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto60_all, KetoHours60, MedianSampleTime) #4987 obs of 6 variables
colnames(df.avgmax60d)[colnames(df.avgmax60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast30"
# Merge data (Average 60DFC KETOSIS)
df.keto1 <- merge(df.avg10_60d, df.avgmax60d, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours60'), all.x=TRUE, all.y=TRUE) #5035 obs of 7 variables
df.keto2 <- merge(df.dur60, df.keto1, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours60'), all.x=TRUE, all.y=TRUE) #5068 ofbs of 8 variables
# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 30) %>% #158279 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto60_all, KetoHours60, MedianSampleTime) #4987 obs of 6 variables
View(df.keto2)
######################################################
# When did the cow has the highest BHB within 60DFC? #
######################################################
df.max60d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(rDFC, BHBraw) %>%
filter(rDFC <= 60) #%>% #91725 obs of 5 variables
######################################################
# When did the cow has the highest BHB within 60DFC? #
######################################################
df.max60d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(rDFC, BHBraw) %>%
filter(rDFC <= 60) %>% #159632 obs of 5 variables
filter(BHBraw == max(BHBraw)) #5105 obs of 5 variables
names(df.max60d.all)[names(df.max60d.all) == "BHBraw"] <- "MaxKeto60"
names(df.max60d.all)[names(df.max60d.all) == "rDFC"] <- "MaxKetoDFC60"
df.keto3 <- merge(df.keto2, df.max60d.all, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 10 variables
##########################################
# Number of times BHB>0.08 within 60 DFC #
##########################################
df.highketo.60d <- df.dur1_60 %>%
filter(BHBraw >= 0.08) #%>% #21443 obs of 11 variables
##########################################
# Number of times BHB>0.08 within 60 DFC #
##########################################
df.highketo.60d <- df.dur1_60 %>%
filter(BHBraw >= 0.08) %>% #40812 obs of 11 variables
group_by(FarmNo, CowId, Lactation) %>%
mutate(nHighKeto60 = n()) %>%
distinct(FarmNo, CowId, Lactation, nHighKeto60) #3028 obs of 4 variables
df.keto4 <- merge(df.keto3, df.highketo.60d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 11 variables
##############################
# Ketosis data within 20 DFC #
##############################
# Filter out all the measurements after 20 DIM
df.avg20d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(Lactation, rDFC, BHBraw) %>%
filter(rDFC <=20) %>%
mutate(AvgKeto20 = mean(BHBraw, na.rm = TRUE)) %>%
distinct(FarmNo, CowId, Lactation, AvgKeto20) #5068 obs of 4 variables
##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_20 <- data.frame()
df.dur1_20 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 20) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_20DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_20DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto20_all = mean(BHBraw, na.rm = TRUE),
MaxDFC = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours20 = sum(Hours_20DFC, na.rm=TRUE)) #91725 obs of 11 variables
df.dur20 <- df.dur1_20 %>%
distinct(FarmNo, CowId, Lactation, KetoHours20, MedianSampleTime, AvgKeto20_all) #5068 obs of 6 variables
# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur20 %>%
filter(FarmNo == 1002, CowId == 581)
## Strictness of the days of measurement
# Select all cows that have the maxDFC above 10
df.avg10_20d <- df.dur1_20 %>%
filter(MaxDFC >= 10) %>% #91594 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto20_all, KetoHours20, MedianSampleTime) #5035 obs of 6 variables
colnames(df.avg10_20d)[colnames(df.avg10_20d) == "AvgKeto20_all"] <- "AvgKeto20_atleast10"
# Only select cows that have the maxDFC = 20
df.avgmax20d <- df.dur1_20 %>%
filter(MaxDFC == 20) %>% #83951 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto20_all, KetoHours20, MedianSampleTime) #4524 obs of 6 variables
colnames(df.avgmax20d)[colnames(df.avgmax20d) == "AvgKeto20_all"] <- "AvgKeto20_atleast20"
# Duplicated lactatrions cows exist?
df.test <- df.avgmax20d %>%
filter(FarmNo == 1002, CowId == 581)
# Merge data (Average 20DFC KETOSIS)
df.keto1 <- merge(df.avg10_20d, df.avgmax20d, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours20'), all.x=TRUE, all.y=TRUE) #5035 obs of 7 variables
df.keto2 <- merge(df.dur20, df.keto1, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours20'), all.x=TRUE, all.y=TRUE) #5068 ofbs of 8 variables
######################################################
# When did the cow has the highest BHB within 20DFC? #
######################################################
df.max20d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(rDFC, BHBraw) %>%
filter(rDFC <= 20) %>% #91725 obs of 5 variables
filter(BHBraw == max(BHBraw)) #5105 obs of 5 variables
names(df.max20d.all)[names(df.max20d.all) == "BHBraw"] <- "MaxKeto20"
names(df.max20d.all)[names(df.max20d.all) == "rDFC"] <- "MaxKetoDFC20"
df.keto3 <- merge(df.keto2, df.max20d.all, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 10 variables
##########################################
# Number of times BHB>0.08 within 20 DFC #
##########################################
df.highketo.20d <- df.dur1_20 %>%
filter(BHBraw >= 0.08) %>% #21443 obs of 11 variables
group_by(FarmNo, CowId, Lactation) %>%
mutate(nHighKeto20 = n()) %>%
distinct(FarmNo, CowId, Lactation, nHighKeto20) #3028 obs of 4 variables
df.ketosis20 <- merge(df.keto3, df.highketo.20d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 11 variables
##############################
# Ketosis data within 60 DFC #
##############################
##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_60 <- data.frame()
df.dur1_60 <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(DFC, rDFC, BHBraw, SamplingTime) %>%
filter(rDFC <= 60) %>%
summarise(DFC, rDFC, Lactation, BHBraw,
Hours_60DFC = ifelse(BHBraw >= 0.08, SamplingTime - lag(SamplingTime), 0), #Hours_60DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
AvgKeto60_all = mean(BHBraw, na.rm = TRUE),
MaxDFC60 = max(rDFC),
MedianSampleTime = median(SamplingTime)) %>%
mutate(KetoHours60 = sum(Hours_60DFC, na.rm=TRUE)) #159632 obs of 11 variables
df.dur60 <- df.dur1_60 %>%
distinct(FarmNo, CowId, Lactation, KetoHours60, MedianSampleTime, AvgKeto60_all) #5107 obs of 6 variables
# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur60 %>%
filter(FarmNo == 1002, CowId == 581)
## Strictness of the days of measurement
# Select all cows that have the maxDFC above 10
df.avg10_60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 10) %>% #159526 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto60_all, KetoHours60, MedianSampleTime) #5068 obs of 6 variables
colnames(df.avg10_60d)[colnames(df.avg10_60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast10"
# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
filter(MaxDFC60 >= 30) %>% #158279 obs of 11 variables
distinct(FarmNo, CowId, Lactation,
AvgKeto60_all, KetoHours60, MedianSampleTime) #4987 obs of 6 variables
colnames(df.avgmax60d)[colnames(df.avgmax60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast30"
# Duplicated lactatrions cows exist?
df.test <- df.avgmax60d %>%
filter(FarmNo == 1002, CowId == 581)
# Merge data (Average 60DFC KETOSIS)
df.keto1 <- merge(df.avg10_60d, df.avgmax60d, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours60'), all.x=TRUE, all.y=TRUE) #5081 obs of 7 variables
df.keto2 <- merge(df.dur60, df.keto1, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoHours60'), all.x=TRUE, all.y=TRUE) #5107 ofbs of 8 variables
######################################################
# When did the cow has the highest BHB within 60DFC? #
######################################################
df.max60d.all <- all_keto_raw %>%
group_by(FarmNo, CowId, Lactation) %>%
select(rDFC, BHBraw) %>%
filter(rDFC <= 60) %>% #159632 obs of 5 variables
filter(BHBraw == max(BHBraw)) #5121 obs of 5 variables
names(df.max60d.all)[names(df.max60d.all) == "BHBraw"] <- "MaxKeto60"
names(df.max60d.all)[names(df.max60d.all) == "rDFC"] <- "MaxKetoDFC60"
df.keto3 <- merge(df.keto2, df.max60d.all, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5121 obs of 10 variables
##########################################
# Number of times BHB>0.08 within 60 DFC #
##########################################
df.highketo.60d <- df.dur1_60 %>%
filter(BHBraw >= 0.08) %>% #40812 obs of 11 variables
group_by(FarmNo, CowId, Lactation) %>%
mutate(nHighKeto60 = n()) %>%
distinct(FarmNo, CowId, Lactation, nHighKeto60) #3805 obs of 4 variables
df.ketosis60 <- merge(df.keto3, df.highketo.60d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5121 obs of 11 variables
View(df.ketosis20)
#########################################
# Merge all ketosis variables (20 + 60) #
#########################################
ketosis <- merge(df.ketosis20, df.ketosis60, by = c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F)
View(ketosis)
rm(list = ls(pattern = "df"))
#################
#     TODO      #
#  Descriptive  #
#################
hist(ketosis$AvgKeto20, main = "Histogram of mean milk BHBraw of each cows", xlab = "mean milk BHBraw (mmol/L)")
View(ketosis)
#################
#     TODO      #
#  Descriptive  #
#################
hist(ketosis$AvgKeto20_atleast20, main = "Histogram of mean milk BHBraw of each cows", xlab = "mean milk BHBraw (mmol/L)")
##################################
#  COW LEVEL Reproduction Events #
##################################
# Select the reproduction parameters that are going to use in cow level
work <- all_farm%>%
select(FarmNo, CowId,
BirthDate, CalvingDate,
Lactation,
DFC_CLA, DFCFirstHeat,
DaysToFirstIns, DaysToLastIns, DaysBtwFirstAndLastIns,
InsDate, InsNumber,
PregDate.x, PregDate.y,
AbortionDate, DaysToAbort) %>%
distinct(FarmNo, CowId, Lactation,
InsNumber, PregDate.x,
.keep_all=TRUE)
# How many cows in 38 farms will remain?
df.work.ind <- work %>%
distinct(FarmNo, CowId, .keep_all = TRUE) #5,262 cows
# How many cows have 2 lactation data?
df.work.lact <- work %>%
distinct(FarmNo, CowId, Lactation, .keep_all=TRUE) #5,327 cows
# When was the 1st AI? If abortion happened after 1st AI? (cow level)
df.ins1 <- all_farm %>%
group_by(FarmNo, CowId, Lactation, CalvingDate) %>%
summarize(First_AI=min(InsNumber),
First_PregDate=min(PregDate.x),
First_InsDate=min(InsDate),
First_AbortionDate=min(AbortionDate))
# When was the last AI? If abortion happened after last AI? (cow level)
df.insN <- all_farm %>%
group_by(FarmNo, CowId, Lactation, CalvingDate) %>%
summarize(Last_AI=max(InsNumber),
Last_PregDate=max(PregDate.x),
Last_InsDate=max(InsDate),
Last_AbortionDate=max(AbortionDate))
# When Last_AI is 1, meaning the cow was inseminated only once
#df.insN$Last_AI[df.insN$Last_AI == 1] <- NA
# Change the last Pregnant/AI/Abortion Date into character and others NA
df.insN$Last_PregDate <- ifelse(is.na(df.insN$Last_AI), NA,
as.character(df.insN$Last_PregDate))
df.insN$Last_InsDate <- ifelse(is.na(df.insN$Last_AI), NA,
as.character(df.insN$Last_InsDate))
df.insN$Last_AbortionDate <- as.Date(df.insN$Last_AbortionDate)
which.max(df.insN$Gap)
# Merge 1st and last AI
df.ins.all <- data.frame()
df.ins.all <- merge(df.ins1, df.insN, by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
all.y=TRUE, sort=F)
# Merge reproduction events to get all reproductive events
df.work_repro <- data.frame()
df.work_repro <- merge(work, df.ins.all,
by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
all.y = TRUE, sort=F) %>%
distinct(FarmNo, CowId, Lactation, CalvingDate, .keep_all=TRUE)
# Delete columns
df.work_repro$PregDate.x <- NULL
df.work_repro$PregDate.y <- NULL
df.work_repro$InsDate <- NULL
df.work_repro$InsNumber <- NULL
# Delete all cows without FarmNo.
repro <- subset(df.work_repro, !is.na(df.work_repro$FarmNo)) #5129 obs of 22 variables (include individual cows with different lactation)
rm(list=ls(pattern="df"))
##################
# Calving Season #
##################
source(CalvingSeason())
View(ketosis)
#if the cow does not have any value over 0.08 within 20 DFC, the number of High BHB measure = 0
ketosis$nHighKeto20 <- ifelse((!is.na(ketosis$MaxKeto20) & (ketosis$MaxKeto20 < 0.08)), 0, ketosis$nHighKeto20)
#if the cow does not have any value over 0.08 within 60 DFC, the number of High BHB measure = 0
ketosis$nHighKeto60 <- ifelse((!is.na(ketosis$MaxKeto60) & (ketosis$MaxKeto60 < 0.08)), 0, ketosis$nHighKeto60)
View(reproduction)
View(reproduction)
View(reproduction)
###########################################
# select reproduction events of interests #
###########################################
df.preg <- all_farm %>%
select(FarmNo, CowId,
BirthDate, CalvingDate,
Lactation,
CullDate,
InsDate, InsNumber, NextIns,
PregDate.x, PregDate.y, DeterminationType,
AbortionDate, DaysToAbort)
# Select the pregnancy determined by HN system (DeterminationType = 2)
df.preg1 <- df.preg[(df.preg$DeterminationType == 2 | is.na(df.preg$DeterminationType)), ]
#Remove rows with FarmNo = NA
df.preg2 <- df.preg1[!is.na(df.preg1$FarmNo), ]
df.preg1 <- df.preg2
rm(df.preg2)
#Remove column PregDate.x
df.preg1$PregDate.x <- NULL
#######################
#  Check consistency  #
#######################
# Change date to as.Date Calving, Preg, Culling, InsDate, AbortionDate
df.preg1$CalvingDate <- as.Date(df.preg1$CalvingDate)
df.preg1$PregDate.y <- as.Date(df.preg1$PregDate.y)
df.preg1$CullDate <- as.Date(df.preg1$CullDate)
df.preg1$InsDate <- as.Date(df.preg1$InsDate)
df.preg1$AbortionDate <- as.Date(df.preg1$AbortionDate)
# Culling date before 2018-06-01 is outside the cohort time
df.preg1$CullDate[df.preg1$CullDate <= "2018-05-31"] <- NA
# Time difference between (Preg and Calving Date)
df.preg1$preg.calving <- difftime(df.preg1$PregDate.y, df.preg1$CalvingDate, units="days")
# Time difference between (Preg and InsDate)
df.preg1$preg.ins <- difftime(df.preg1$PregDate.y, df.preg1$InsDate, units="days")
# Time difference between (Culling and Calving Date)
df.preg1$cull.calving <- difftime(df.preg1$CullDate,
df.preg1$CalvingDate, units="days")
# Binary variable(Culled); culled cow = 1, not culled = 0
df.preg1$Culled_Status <- ifelse(!is.na(df.preg1$cull.calving), 1, 0)
#View(df.preg1)
# Exclude rows that have been culled within 150 DIM
df.preg1 <- df.preg1[-which(df.preg1$cull.calving < 150), ] #df.preg1 has 22987 obs of 15 variables
# number of cows
df.cow <- df.preg1 %>%
distinct(FarmNo, CowId, CalvingDate) #4,712 cows
# Time difference between (AbortionDate - PregDate)
df.preg1$abort.preg <- difftime(df.preg1$AbortionDate, df.preg1$PregDate.y,
units = "days")
# Time difference between (AbortionDate - InsDate)
df.preg1$abort.calving <- difftime(df.preg1$AbortionDate, df.preg1$CalvingDate,
units = "days")
# Time difference between (PregDate - InsDate)
df.preg1$preg.ins <- difftime(df.preg1$PregDate.y, df.preg1$InsDate, units="days")
# If InsDate is behind PregDate (detected by HN system), the cow was not pregnent after the insemination
df.preg1$Preg_Status <- ifelse(df.preg1$preg.ins <=0, "0", "1")
df.test <- df.preg1 %>%
filter(is.na(Preg_Status)) #there are 595 unknow preg. status
#############
#   Merge   #
#############
reproduction <- data.frame()
reproduction <- merge(repro, df.preg1,
by = c('FarmNo', 'CowId', 'Lactation',
'CalvingDate', 'BirthDate',
'AbortionDate', 'DaysToAbort'),
all.x = TRUE, sort=F) %>%
distinct(FarmNo, CowId, Lactation, CalvingDate, .keep_all=TRUE)
View(reproduction)
