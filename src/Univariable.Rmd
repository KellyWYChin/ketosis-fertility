---
title: "Univariable"
author: "Kelly Chin"
date: "2/22/2022"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R libraries
```{r library, message=FALSE, warning=FALSE}
library(readxl)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(reader)
library(lubridate)
library(docstring)
library(roxygen2)
library(corrplot)
``` 

# DATA PREPARATION

## Reproduction data 
```{r warning=FALSE, include=FALSE}
#########################
#   Merge Reproduction  #
#########################
# Merge reproduction data from 38 farms
# empty the data frame first
all_farm_raw <- data.frame()

for (i in 1001:1038) {
  # create the excel file name base on the input i
  filename <- paste("../data/raw/", i,", All Data, Proc, June 2020.xlsx", sep = "")

  # load the sheets within the same excel file (the same farm)
  df.calving <- read_excel(filename, sheet = "Calving")
  df.cowinfo <- read_excel(filename, sheet = "CowInfo")
  # change the column name of cowinfo (CowID -> CowId)
  colnames(df.cowinfo)[colnames(df.cowinfo)=="CowID"] <- "CowId"
  # change the column BirthDate into character
  df.cowinfo$BirthDate <- as.character(df.cowinfo$BirthDate)
  df.culldata <- read_excel(filename, sheet = "CullData")
  df.calving <- read_excel(filename, sheet = "Calving")
  df.insemination <- read_excel(filename, sheet = "Insemination")
  df.pregnancy <- read_excel(filename, sheet = "Pregnancy")

  # merge the data of different sheets within the same farm
  df.farm <- merge(df.cowinfo, df.calving, by = "CowId", all.x=TRUE, all.y=TRUE) %>%
    merge(df.culldata, by = "CowId", all.x = TRUE, all.y=TRUE) %>%
    merge(df.insemination, by = "CowId", all.x=TRUE, all.y=TRUE) %>%
    merge(df.pregnancy, by = "CowId", all.x=TRUE, all.y=TRUE)

  # append all the merged data into the master final data table
  all_farm_raw <- bind_rows(all_farm_raw, df.farm)
}
rm(list=ls(pattern="df"))
summary(all_farm_raw)

# Delete all the rows that without calving date and FarmNo
all_farm <- subset(all_farm_raw, !is.na(all_farm_raw$CalvingDate)) #46013 obs 31v
all_farm <- subset(all_farm, !is.na(all_farm$FarmNo)) #45412 obs 31v
df.cow <- all_farm %>%
  distinct(FarmNo, CowId) #5069 obs
rm(all_farm_raw)
nrow(all_farm)
str(all_farm)
all_farm$BirthDate <- as.Date(all_farm$BirthDate)

# change weird date signs to NAs
all_farm$EEDDate <- as.Date(all_farm$NextIns)
all_farm$EEDDate[all_farm$EEDDate == "1899-12-31"] <- NA
all_farm$NextIns <- as.Date(all_farm$NextIns)
all_farm$NextIns[all_farm$NextIns == "1899-12-31 00:00:00"] <- NA
all_farm$PregDate.x <- as.Date(all_farm$PregDate.x)
all_farm$PregDate.x[all_farm$PregDate.x == "1899-12-31 00:00:00"] <- NA
all_farm$AbortionDate <- as.Date(all_farm$AbortionDate)
all_farm$AbortionDate[all_farm$AbortionDate == "1899-12-31 00:00:00"] <- NA
summary(all_farm)
```
```{r warning=FALSE, include=FALSE}
##################################
#  COW LEVEL Reproduction Events #
##################################
# Select the reproduction parameters that are going to use in cow level
work <- all_farm%>%
  select(FarmNo, CowId, 
         BirthDate, CalvingDate, 
         Lactation, 
         DFC_CLA, DFCFirstHeat, 
         DaysToFirstIns, DaysToLastIns, DaysBtwFirstAndLastIns, 
         InsDate, InsNumber, 
         PregDate.x, PregDate.y, 
         AbortionDate, DaysToAbort) %>%
  distinct(FarmNo, CowId, Lactation, 
           InsNumber, PregDate.x,
           .keep_all=TRUE)

# How many cows in 38 farms will remain?
df.work.ind <- work %>%
  distinct(FarmNo, CowId, .keep_all = TRUE) #5,069 cows
# How many cows have 2 lactation data?
df.work.lact <- work %>%
  distinct(FarmNo, CowId, Lactation, .keep_all=TRUE) #5,129 cows

# When was the 1st AI? If abortion happened after 1st AI? (cow level)
df.ins1 <- all_farm %>%
  group_by(FarmNo, CowId, Lactation, CalvingDate) %>%
  summarize(First_AI=min(InsNumber), 
            First_PregDate=min(PregDate.x), 
            First_InsDate=min(InsDate), 
            First_AbortionDate=min(AbortionDate))

# When was the last AI? If abortion happened after last AI? (cow level)
df.insN <- all_farm %>%
  group_by(FarmNo, CowId, Lactation, CalvingDate) %>%
  summarize(Last_AI=max(InsNumber), 
            Last_PregDate=max(PregDate.x), 
            Last_InsDate=max(InsDate), 
            Last_AbortionDate=max(AbortionDate))

# When Last_AI is 1, meaning the cow was inseminated only once
#df.insN$Last_AI[df.insN$Last_AI == 1] <- NA
# Change the last Pregnant/AI/Abortion Date into character and others NA
df.insN$Last_PregDate <- ifelse(is.na(df.insN$Last_AI), NA,
                             as.character(df.insN$Last_PregDate))
df.insN$Last_InsDate <- ifelse(is.na(df.insN$Last_AI), NA,
                            as.character(df.insN$Last_InsDate))
df.insN$Last_AbortionDate <- as.Date(df.insN$Last_AbortionDate)
which.max(df.insN$Gap)

# Merge 1st and last AI
df.ins.all <- data.frame()
df.ins.all <- merge(df.ins1, df.insN, by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'), 
                    all.y=TRUE, sort=F)
# Merge reproduction events to get all reproductive events
df.work_repro <- data.frame()
df.work_repro <- merge(work, df.ins.all,
                       by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'), 
                       all.y = TRUE, sort=F) %>%
  distinct(FarmNo, CowId, Lactation, CalvingDate, .keep_all=TRUE)
# Delete columns
df.work_repro$PregDate.x <- NULL
df.work_repro$PregDate.y <- NULL
df.work_repro$InsDate <- NULL
df.work_repro$InsNumber <- NULL
# Delete all cows without FarmNo.
repro <- subset(df.work_repro, !is.na(df.work_repro$FarmNo)) #5129 obs of 22 variables (include individual cows with different lactation)
rm(list=ls(pattern="df"))
```

## Reproduction data 
### time differences between reproduction events
```{r warning=FALSE, include=FALSE}
###########################################
# select reproduction events of interests #
###########################################
df.preg <- all_farm %>%
  select(FarmNo, CowId, 
         BirthDate, CalvingDate, 
         Lactation, 
         CullDate, 
         InsDate, InsNumber, NextIns, 
         PregDate.x, PregDate.y, DeterminationType, 
         AbortionDate, DaysToAbort)
summary(df.preg)

# Select the pregnancy determined by HN system (DeterminationType = 2)
df.preg1 <- df.preg[(df.preg$DeterminationType == 2 | is.na(df.preg$DeterminationType)), ]
summary(df.preg1)
#Remove rows with FarmNo = NA
df.preg2 <- df.preg1[!is.na(df.preg1$FarmNo), ]
summary(df.preg2)
df.preg1 <- df.preg2
rm(df.preg2)

#Remove column PregDate.x
df.preg1$PregDate.x <- NULL
summary(df.preg1) #df.preg1 has 23296 obs of 13 variables

df.cow <- df.preg1 %>%
  distinct(FarmNo, CowId) #4910 cows
#######################
#  Check consistency  #
#######################
# Change date to as.Date Calving, Preg, Culling, InsDate, AbortionDate
df.preg1$CalvingDate <- as.Date(df.preg1$CalvingDate)
df.preg1$PregDate.y <- as.Date(df.preg1$PregDate.y)
df.preg1$CullDate <- as.Date(df.preg1$CullDate)
df.preg1$InsDate <- as.Date(df.preg1$InsDate)
df.preg1$AbortionDate <- as.Date(df.preg1$AbortionDate)

# Culling date before 2018-06-01 is outside the cohort time
df.preg1$CullDate[df.preg1$CullDate <= "2018-05-31"] <- NA

# Time difference between (Preg and Calving Date) 
df.preg1$preg.calving <- difftime(df.preg1$PregDate.y, df.preg1$CalvingDate, units="days")
# Time difference between (Preg and InsDate)
df.preg1$preg.ins <- difftime(df.preg1$PregDate.y, df.preg1$InsDate, units="days") 
# Time difference between (Culling and Calving Date)
df.preg1$cull.calving <- difftime(df.preg1$CullDate, 
                                  df.preg1$CalvingDate, units="days")
# Binary variable(Culled); culled cow = 1, not culled = 0
df.preg1$Culled_Status <- ifelse(is.na(df.preg1$cull.calving), 0, 1)
#View(df.preg1)
# 23296 obs of 17 variables

# number of cows
df.cow <- df.preg1 %>%
  distinct(FarmNo, CowId, CalvingDate) #4,970 cows (with repeated cows)

# Time difference between (AbortionDate - PregDate) 
df.preg1$abort.preg <- difftime(df.preg1$AbortionDate, 
                                df.preg1$PregDate.y, 
                                units = "days")
# Time difference between (AbortionDate - InsDate)
df.preg1$abort.calving <- difftime(df.preg1$AbortionDate,
                                   df.preg1$CalvingDate, 
                                   units = "days")

# exclude rows with negative DaysToAbort -> Don't do so!
#df.preg1 <- df.preg1[(df.preg1$DaysToAbort >=0 | is.na(df.preg1$DaysToAbort)), ]

# Time difference between (PregDate - InsDate)
df.preg1$preg.ins <- difftime(df.preg1$PregDate.y, 
                              df.preg1$InsDate, units="days")
# If InsDate is behind PregDate (detected by HN system), the cow was not pregnent after the insemination 
df.preg1$Preg_Status <- ifelse(df.preg1$preg.ins <=0, "0", "1")
df.test <- df.preg1 %>%
  filter(is.na(Preg_Status))#there are 848 unknow preg. status
df.test <- df.preg1 %>%
  distinct(FarmNo, CowId, Lactation) #4970 cows
df.test <- df.preg1 %>%
  distinct(FarmNo, CowId, Lactation, cull.calving) #4970 cows

## TODO
# Exclude rows that have negative values of time between pregnancy and calving
#df.preg1 <- df.preg1[(df.preg1$preg.calving >=0 | is.na(df.preg1$preg.calving)), ]

##ã€€TODO 
# Exclude the negative time difference between preg date and AI 
#df.preg1 <- df.preg1[(df.preg1$preg.ins >=0 | is.na(df.preg1$preg.ins)), ]
#summary(df.preg1)
#df.data3 <- df.preg1 %>% distinct(FarmNo, CowId)

#############
#   Merge   #
#############
reproduction <- data.frame()
reproduction <- merge(repro, df.preg1,
                       by = c('FarmNo', 'CowId', 'Lactation', 
                              'CalvingDate', 'BirthDate',
                              'AbortionDate', 'DaysToAbort'), 
                       all.x = TRUE, sort=F) %>%
  distinct(FarmNo, CowId, Lactation, CalvingDate, .keep_all=TRUE) 
summary(reproduction) # 5129 obs of 33 variables
rm(list = ls(pattern="df"))
rm(repro, work)

##################
# Calving Season #
##################
CalvingSeason <- function(DATES){
  WS <- as.Date("2012-1-1", format="%Y-%m-%d")
  SE <- as.Date("2012-4-1", format="%Y-%m-%d")
  SS <- as.Date("2012-7-1", format="%Y-%m-%d")
  FE <- as.Date("2012-10-1", format="%Y-%m-%d")

  d <- as.Date(strftime(DATES, format="2012-%m-%d"))
  ifelse(d >= WS & d < SE, "Winter",
         ifelse(d >= SE & d < SS, "Spring",
                ifelse(d >= SS & d < FE, "Summer", "Fall")))
}
reproduction <- reproduction %>%
  add_column(CalvingSeason =
               CalvingSeason(reproduction$CalvingDate),
             .after="CalvingDate") # 5129 obs of 33 variables
 # add_column(ECC = ifelse((repro$Ins.Calving <= 80 & repro$PregStatus_1 == "1"), 1, 0))
```

## Ketosis data

* BHB measurements did not start from the same day (mostly 3 or 4 DFC)
* some cows have a more frequent measurement of BHB (more than once per day)

```{r warning=FALSE, include=FALSE}
all_keto_raw <- data.frame()
for(i in 1001:1038){
  filename <- paste("../data/raw/",i,", All Data, Proc, June 2020.xlsx", sep = "")
  df.keto <- read_excel(filename, sheet = "Ketosis")
  
  all_keto_raw <- bind_rows(all_keto_raw, df.keto) %>%
    group_by(FarmNo, CowId) %>%
    arrange(DFC, .by_group = TRUE)
} 
summary(all_keto_raw)
rm(list=ls(pattern="df"))

all_keto_raw$rDFC <- round(all_keto_raw$DFC)
# Change the column name "Parity" to "Lactation"
colnames(all_keto_raw)[colnames(all_keto_raw) == "Parity"] <- "Lactation"
summary(all_keto_raw) #161708 obs of 12 variables
```
```{r, warning=FALSE, include=FALSE}
##############################
# Ketosis data within 20 DFC #
##############################
# Filter out all the measurements after 20 DIM
df.avg20d.all <- all_keto_raw %>%
  group_by(FarmNo, CowId, Lactation) %>%
  select(Lactation, rDFC, BHBraw) %>%
  filter(rDFC <=20) %>% #91725 obs 5v
  mutate(AvgKeto20 = mean(BHBraw, na.rm = TRUE)) %>%
  distinct(FarmNo, CowId, Lactation, AvgKeto20) #5068 obs of 4 variables

##############################################################
# Avg milk ketone levels & Duration of ketosis within 20 DFC #
##############################################################
df.dur1_20 <- data.frame()
df.dur1_20 <- all_keto_raw %>%
  group_by(FarmNo, CowId, Lactation) %>%
  select(DFC, rDFC, BHBraw, SamplingTime) %>%
  filter(rDFC <= 20) %>%
  summarise(DFC, rDFC, Lactation, BHBraw,
            Days_20DFC = ifelse(BHBraw >= 0.08, rDFC - lag(rDFC), 0), #Hours_20DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
            AvgKeto20_all = mean(BHBraw, na.rm = TRUE),
            MaxDFC = max(rDFC),
            MedianSampleTime = median(SamplingTime)) %>% 
  mutate(KetoDur20 = sum(Days_20DFC, na.rm=TRUE)) #91725 obs of 11 variables

df.dur20 <- df.dur1_20 %>%
  distinct(FarmNo, CowId, Lactation, KetoDur20, MedianSampleTime, AvgKeto20_all) #5068 obs of 6 variables

# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur20 %>%
  filter(FarmNo == 1002, CowId == 581)

## Strictness of the days of measurement 
# Select all cows that have the maxDFC above 10
df.avg10_20d <- df.dur1_20 %>% 
  filter(MaxDFC >= 10) %>% #91594 obs of 11 variables
  distinct(FarmNo, CowId, Lactation, 
           AvgKeto20_all, KetoDur20, MedianSampleTime) #5035 obs of 6 variables
colnames(df.avg10_20d)[colnames(df.avg10_20d) == "AvgKeto20_all"] <- "AvgKeto20_atleast10"

# Only select cows that have the maxDFC = 20
df.avgmax20d <- df.dur1_20 %>%
  filter(MaxDFC == 20) %>% #83951 obs of 11 variables
  distinct(FarmNo, CowId, Lactation, 
           AvgKeto20_all, KetoDur20, MedianSampleTime) #4524 obs of 6 variables
colnames(df.avgmax20d)[colnames(df.avgmax20d) == "AvgKeto20_all"] <- "AvgKeto20_atleast20"
# Duplicated lactatrions cows exist?
df.test <- df.avgmax20d %>%
  filter(FarmNo == 1002, CowId == 581)

# Merge data (Average 20DFC KETOSIS)
df.keto1 <- merge(df.avg10_20d, df.avgmax20d, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoDur20'), all.x=TRUE, all.y=TRUE) #5035 obs of 7 variables
df.keto2 <- merge(df.dur20, df.keto1, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoDur20'), all.x=TRUE, all.y=TRUE) #5068 ofbs of 8 variables

######################################################
# When did the cow has the highest BHB within 20DFC? #
######################################################
df.max20d.all <- all_keto_raw %>%
  group_by(FarmNo, CowId, Lactation) %>%
  select(rDFC, BHBraw) %>%
  filter(rDFC <= 20) %>% #91725 obs of 5 variables
  filter(BHBraw == max(BHBraw)) #5105 obs of 5 variables
names(df.max20d.all)[names(df.max20d.all) == "BHBraw"] <- "MaxKeto20"
names(df.max20d.all)[names(df.max20d.all) == "rDFC"] <- "MaxKetoDFC20"

df.keto3 <- merge(df.keto2, df.max20d.all, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 10 variables

##########################################
# Number of times BHB>0.08 within 20 DFC #
##########################################
df.highketo.20d <- df.dur1_20 %>%
  filter(BHBraw >= 0.08) %>% #21443 obs of 11 variables
  group_by(FarmNo, CowId, Lactation) %>%
  mutate(nHighKeto20 = n()) %>%
  distinct(FarmNo, CowId, Lactation, nHighKeto20) #3028 obs of 4 variables

df.ketosis20 <- merge(df.keto3, df.highketo.20d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5105 obs of 11 variables

###########
# 60 days #
##############################
# Ketosis data within 60 DFC #
##############################################################
# Avg milk ketone levels & Duration of ketosis within 60 DFC #
##############################################################
df.dur1_60 <- data.frame()
df.dur1_60 <- all_keto_raw %>%
  group_by(FarmNo, CowId, Lactation) %>%
  select(DFC, rDFC, BHBraw, SamplingTime) %>%
  filter(rDFC <= 60) %>% #159632 obs of 7v
  summarise(DFC, rDFC, Lactation, BHBraw,
            Days_60DFC = ifelse(BHBraw >= 0.08, rDFC - lag(rDFC), 0), #Hours_60DFC = if single measure of BHBraw is over 0.08, the duration of BHBraw over 0.08 will be calculated in hours
            AvgKeto60_all = mean(BHBraw, na.rm = TRUE),
            MaxDFC60 = max(rDFC),
            MedianSampleTime = median(SamplingTime)) %>% 
  mutate(KetoDur60 = sum(Days_60DFC, na.rm=TRUE)) #159632 obs of 11 variables

df.dur60 <- df.dur1_60 %>%
  distinct(FarmNo, CowId, Lactation, KetoDur60, MedianSampleTime, AvgKeto60_all) #5107 obs of 6 variables

# Test if cows cover 2 lactation are still involved in the dataset
df.test <- df.dur60 %>%
  filter(FarmNo == 1002, CowId == 581)

## Strictness of the days of measurement 
# Select all cows that have the maxDFC above 10
df.avg10_60d <- df.dur1_60 %>% 
  filter(MaxDFC60 >= 10) %>% #159526 obs of 11 variables
  distinct(FarmNo, CowId, Lactation, 
           AvgKeto60_all, KetoDur60, MedianSampleTime) #5068 obs of 6 variables
colnames(df.avg10_60d)[colnames(df.avg10_60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast10"

# Only select cows that have the maxDFC >= 30
df.avgmax60d <- df.dur1_60 %>%
  filter(MaxDFC60 >= 30) %>% #158279 obs of 11 variables
  distinct(FarmNo, CowId, Lactation, 
           AvgKeto60_all, KetoDur60, MedianSampleTime) #4987 obs of 6 variables
colnames(df.avgmax60d)[colnames(df.avgmax60d) == "AvgKeto60_all"] <- "AvgKeto60_atleast30"
# Duplicated lactatrions cows exist?
df.test <- df.avgmax60d %>%
  filter(FarmNo == 1002, CowId == 581)

# Merge data (Average 60DFC KETOSIS)
df.keto1 <- merge(df.avg10_60d, df.avgmax60d, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoDur60'), all.x=TRUE, all.y=TRUE) #5081 obs of 7 variables
df.keto2 <- merge(df.dur60, df.keto1, by=c('FarmNo', 'CowId', 'Lactation', 'MedianSampleTime', 'KetoDur60'), all.x=TRUE, all.y=TRUE) #5107 ofbs of 8 variables

######################################################
# When did the cow has the highest BHB within 60DFC? #
######################################################
df.max60d.all <- all_keto_raw %>%
  group_by(FarmNo, CowId, Lactation) %>%
  select(rDFC, BHBraw) %>%
  filter(rDFC <= 60) %>% #159632 obs of 5 variables
  filter(BHBraw == max(BHBraw)) #5121 obs of 5 variables
names(df.max60d.all)[names(df.max60d.all) == "BHBraw"] <- "MaxKeto60"
names(df.max60d.all)[names(df.max60d.all) == "rDFC"] <- "MaxKetoDFC60"

df.keto3 <- merge(df.keto2, df.max60d.all, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5121 obs of 10 variables

##########################################
# Number of times BHB>0.08 within 60 DFC #
##########################################
df.highketo.60d <- df.dur1_60 %>%
  filter(BHBraw >= 0.08) %>% #40812 obs of 11 variables
  group_by(FarmNo, CowId, Lactation) %>%
  mutate(nHighKeto60 = n()) %>%
  distinct(FarmNo, CowId, Lactation, nHighKeto60) #3805 obs of 4 variables

df.ketosis60 <- merge(df.keto3, df.highketo.60d, by=c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5121 obs of 11 variables

# if the cow does not have any value over 0.08 within 60 DFC, the number of High BHB measure = 0
df.ketosis60$nHighKeto60 <- ifelse((!is.na(df.ketosis60$MaxKeto60) & (df.ketosis60$MaxKeto60 < 0.08)), 0, df.ketosis60$nHighKeto60)
# if the cow does not have any value over 0.08 within 60 DFC, the number of High BHB measure = 0
df.ketosis60$nHighKeto60 <- ifelse((!is.na(df.ketosis60$MaxKeto60) & (df.ketosis60$MaxKeto60 < 0.08)), 0, df.ketosis60$nHighKeto60)

#########################################
# Merge all ketosis variables (20 + 60) #
#########################################
ketosis <- merge(df.ketosis20, df.ketosis60, by = c('FarmNo', 'CowId', 'Lactation'), all.x=TRUE, all.y=TRUE, sort = F) #5146 obs of 19 variables
rm(list = ls(pattern = "df"))
```

## Milk data
```{r, warning=FALSE, include=FALSE}
df.lact <- all_farm %>%
  select(CowId, FarmNo, CalvingDate, Lactation, PeakYield, PeakDim) %>%
  distinct(CowId, FarmNo, Lactation, CalvingDate, .keep_all=TRUE)

all_milk_raw <- data.frame()
for (i in 1001:1038) {
  filename <- paste("../data/raw/",i,", All Data, Proc, June 2020.xlsx", sep = "")
  df.milk <- read_excel(filename, sheet = "MilkData")
  df.cowinfo <- read_excel(filename, sheet = "CowInfo")
  # change the column name of cowinfo (CowID -> CowId)
  colnames(df.cowinfo)[colnames(df.cowinfo)=="CowID"] <- "CowId"
  df.cowinfo$BirthDate <- as.character(df.cowinfo$BirthDate)
  
  df.milkfarm <- merge(df.cowinfo, df.milk, by = "CowId", all.x= TRUE, all.y=TRUE) %>%
    group_by(FarmNo, CowId) %>%
    arrange(DFC, .by_group = TRUE)

  all_milk_raw <- bind_rows(all_milk_raw, df.milkfarm)
}
all_milk_raw
all_milk_raw$CowNo <- NULL
all_milk_raw$BirthDate <- NULL
all_milk_raw$Inclusion <- NULL
all_milk_raw$HasMilkLactCowID <- NULL
all_milk <- all_milk_raw %>%
  distinct(FarmNo, CowId)

#create a milk dataframe including all milk information from 38 farms #
df.merge <- data.frame()
df.merge <- merge(df.lact, all_milk_raw, by=c('FarmNo', 'CowId'), all.x=TRUE, all.y=TRUE) %>%
  group_by(FarmNo, CowId, CalvingDate) %>%
  arrange(DFC, .by_group=TRUE)
summary(df.merge)

# Exclude cows without FarmNo
df.merge <- df.merge[!is.na(df.merge$FarmNo), ]
summary(df.merge)
# Exclude cows without CowId, Calving Date
df.merge$CalvingDate <- as.character(df.merge$CalvingDate)
df.merge <- df.merge[!(is.na(df.merge$CowId) | is.na(df.merge$CalvingDate)), ]

# Exclude DIM 1-3 milk yield
df.merge1 <- df.merge %>%
  filter(DFC > 3)
# if daily milk yield <1 kg, we name it as NA; others = original daily milk yield
df.merge1$DayYield <- ifelse(df.merge1$DayYield < 1, NA, df.merge1$DayYield)
df.merge <- df.merge1
# How many cows remain?
df.merge2 <- df.merge1 %>%
  distinct(FarmNo, CowId) #5,119 cows

#############################
#   Cumulative milk yield   #
#############################
# Cumulative milk yield, mean milk yield
cumulativeMY <- function(D){
  df.merge %>%
  group_by(FarmNo, CowId, CalvingDate) %>%
  select(Lactation, DayYield, DFC) %>%
  filter(DFC <= D) %>%
  mutate(!!paste0('AvgMY', D) := mean(DayYield, na.rm = TRUE), 
         MinDFC = min(DFC), 
         MaxDFC = max(DFC), 
         !!paste0('SumMY', D) := sum(DayYield, na.rm = TRUE))
}

# First 20 days
df.first20d <- cumulativeMY(20)

# ONLY when Min DFC = 4 and  Max DFC = 20 the cows can be included into the dataset #
df.first20d.comp <- subset(df.first20d, 
                           MinDFC == "4" & MaxDFC == "20")
# All cows 
df.20dmilk <- df.first20d %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY20, SumMY20) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY20, SumMY20)
# Only the cows have completed 4-20 DIM milk records
df.20d_ind <- df.first20d.comp %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY20, SumMY20) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY20, SumMY20)

# First 60 days
df.first60d <- cumulativeMY(60)
# Only the cows have completed 4-60 DIM milk records
df.first60d.comp <- subset(df.first60d, 
                           MinDFC == "4" & MaxDFC == "60")
summary(df.first60d.comp)
df.60dmilk <- df.first60d %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY60, SumMY60) %>%
  distinct(FarmNo, CowId, Lactation, CalvingDate, AvgMY60, SumMY60)

df.60d_ind <- df.first60d.comp %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY60, SumMY60) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY60, SumMY60)

df.master1 <- merge(df.20d_ind, df.60d_ind, 
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                    all.x=TRUE, all.y=TRUE)
df.master5 <- merge(df.20dmilk, df.60dmilk, 
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                    all.x=TRUE, all.y=TRUE)

# First 80 days
df.first80d <- cumulativeMY(80)
# Only the cows have completed 4-80 DIM milk records
df.first80d.comp <- subset(df.first80d, 
                           MinDFC == "4" & MaxDFC == "80")
df.80dmilk <- df.first80d %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY80, SumMY80) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY80, SumMY80)
df.80d_ind <- df.first80d.comp %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY80, SumMY80) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY80, SumMY80)

df.master2 <- merge(df.master1, df.80d_ind, 
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                    all.x=TRUE, all.y=TRUE)
df.master6 <- merge(df.master5, df.80dmilk, 
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                    all.x=TRUE, all.y=TRUE)
# First 150 days
df.first150d <- cumulativeMY(150)

df.first150d.comp <- subset(df.first150d, 
                            MinDFC == "4" & MaxDFC == "150")

df.150dmilk <- df.first150d %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY150, SumMY150) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY150, SumMY150)

df.150d_ind <- df.first150d.comp %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY150, SumMY150) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY150, SumMY150)

df.master3 <- merge(df.master2, df.150d_ind, 
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                    all.x=TRUE, all.y=TRUE)
df.master7 <- merge(df.master6, df.150dmilk,
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                    all.x=TRUE, all.y=TRUE)

# First 305 days
df.first305d <- cumulativeMY(305)

df.305dmilk <- df.first305d %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY305, SumMY305) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY305, SumMY305)

df.first305d.comp <- subset(df.first305d, 
                            MinDFC == "4" & MaxDFC == "305")

df.305d_ind <- df.first305d.comp %>%
  select(FarmNo, CowId, Lactation, CalvingDate, AvgMY305, SumMY305) %>%
  distinct(FarmNo, CowId, Lactation, AvgMY305, SumMY305)
# complete time period measurements
df.master4 <- merge(df.master3, df.305d_ind,
                    by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'), 
                    all.x = TRUE, all.y = TRUE)
# less strict on the complete days
df.master8 <-merge(df.master7, df.305dmilk, 
                   by=c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'), 
                   all.x=TRUE, all.y=TRUE)
df.lact$CalvingDate <- as.character(df.lact$CalvingDate)
milk <- merge(df.lact, df.master4, 
              by=c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'), 
              all.x=TRUE, all.y=TRUE)
milk <- milk[!is.na(milk$FarmNo), ]

milk_all <- merge(df.lact, df.master8, 
                  by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'),
                  all.x = TRUE, all.y = TRUE)
milk_all <- milk_all[!is.na(milk_all$FarmNo), ]
milk_all <- milk_all[!is.na(milk_all$CalvingDate), ]
rm(list=ls(pattern="df"))
rm(all_milk)
# Exclude cows without Calving Date

# re-categroize Lactation into 4 groups: 1, 2, 3, and 4+
milk$ad_Lactation[milk$Lactation >= 4] <- 4
milk$ad_Lactation[milk$Lactation == 3] <- 3
milk$ad_Lactation[milk$Lactation == 2] <- 2
milk$ad_Lactation[milk$Lactation == 1] <- 1
summary(milk)
milk_all$ad_Lactation[milk_all$Lactation >= 4] <- 4
milk_all$ad_Lactation[milk_all$Lactation == 3] <- 3
milk_all$ad_Lactation[milk_all$Lactation == 2] <- 2
milk_all$ad_Lactation[milk_all$Lactation == 1] <- 1
summary(milk_all)
```

## Merge 3 data sources & Data exclusion
```{r, warning=FALSE, include=FALSE}
#################################
#  Merge ketosis, reproduction  #
#################################
df.two <- merge(reproduction, ketosis, 
                       by = c('FarmNo', 'CowId', 'Lactation'),
                       all.x = TRUE, all.y = TRUE, sort = F) %>%
                       #5230 obs of 50 variables
  distinct(FarmNo, CowId, Lactation, CalvingDate, .keep_all = T) #5173 obs
summary(df.two)
df.two$CalvingDate <- as.Date(df.two$CalvingDate)

# Check if there are duplicated cows -> 60 duplicated cows
df.two$farmcow <- paste(df.two$FarmNo, df.two$CowId, sep="")
# Select cows with 2 parities
df.two_parity <- df.two %>%
  mutate(farmcow.dup = ifelse(duplicated(farmcow)|
                                duplicated(farmcow, 
                                           fromLast=TRUE), 1, 0)) %>%
  filter(farmcow.dup == 1) #120 obs of 52 variables

# Check if reproduction data and ketosis are in the same parity
df.two_parity$MedianSampleTime.x <- as.Date(df.two_parity$MedianSampleTime.x)
df.two_parity <- df.two_parity %>%
  select(FarmNo, CowId, Lactation, CalvingDate, MedianSampleTime.x, farmcow.dup) %>%
  mutate(sample.calving = difftime(MedianSampleTime.x, CalvingDate, units="days")) # Only 4 cows did not have info for one of the parities -> remove these 4 records
# Farm1002, cow 1813
# Farm1002, cow 1817
# Farm1010, cow 179
# Farm1025, cow 197
df.two_parity <- df.two_parity[-which(df.two_parity$CowId == 1813), ]
df.two_parity <- df.two_parity[-which(df.two_parity$FarmNo == 1002& df.two_parity$CowId == 1817), ]
df.two_parity <- df.two_parity[-which(df.two_parity$FarmNo == 1010& df.two_parity$CowId == 179), ]
df.two_parity <- df.two_parity[-which(df.two_parity$FarmNo == 1025& df.two_parity$CowId == 197), ]
#112 obs 7 variables

# Select the first parity
df.test <- df.two_parity %>%
  group_by(FarmNo, CowId) %>%
  filter(Lactation == min(Lactation))

###########################################
#  Merge ketosis, reproduction, and milk  #
###########################################
df.three <- merge(df.two, milk, by = c('FarmNo', 'CowId', 'Lactation', 'CalvingDate'), 
                  all.x = TRUE, all.y = TRUE, sort = F) #5173 obs 64v
summary(df.three) 
df.three$MedianSampleTime.x <- as.Date(df.three$MedianSampleTime.x)

# Exclude cows without data based on the repeated 4 cows
df.three <- df.three[-which(df.three$FarmNo == 1002 & df.three$CowId == 1813 & is.na(df.three$MedianSampleTime.x)), ]
df.three <- df.three[-which(df.three$FarmNo == 1002 & df.three$CowId == 1817 & is.na(df.three$MedianSampleTime.x)), ]
df.three <- df.three[-which(df.three$FarmNo == 1010 & df.three$CowId == 179 & is.na(df.three$MedianSampleTime.x)), ]
df.three <- df.three[-which(df.three$FarmNo == 1025 & df.three$CowId == 197 & is.na(df.three$MedianSampleTime.x)), ]
#5169 obs if 64v

df.three <- df.three %>%
  group_by(FarmNo, CowId) %>%
  filter(Lactation == min(Lactation)) #5113 pbs 64v
  
# Exculde cows without CalvingDate
df.three <- df.three[!is.na(df.three$CalvingDate), ] #5069 obs
# Exclude rows that have been culled within 150 DIM
df.three <- df.three[-which(df.three$cull.calving < 150), ] #4815 obs
summary(df.three)
# Exclude cows without DFC_CLA
df.three <- df.three[!is.na(df.three$DFC_CLA), ] #4754 obs
# Exclude cows with DFC_CLA less than 20 and more than 200
df.three <- df.three[-which(df.three$DFC_CLA < 20 | df.three$DFC_CLA > 200), ] #4692 obs
# Exclude cows DaysToFirstIns <20 DIM and >250 DIM
df.three <- df.three[-which(df.three$DaysToFirstIns < 20 | df.three$DaysToFirstIns >250), ] #4677obs
### Exclude cows DFCFirstHeat <20 DIM and >200 DIM
df.three <- df.three[-which(df.three$DFCFirstHeat < 20 | df.three$DFCFirstHeat > 200), ] #4672 obs
summary(df.three)

# Exclude cows without AvgKeto20_atleast10
df.three <- df.three[!is.na(df.three$AvgKeto20_atleast10), ] #4607 obs
# Exclude cows without AvgMY20
df.three <- df.three[!is.na(df.three$AvgMY20), ] #4506 obs

# Select cows with 2 parities
#df.three$farmcow <- paste(df.three$FarmNo, df.three$CowId, sep="")
#df.three_twoparity <- df.three %>%
  #mutate(farmcow.dup = ifelse(duplicated(farmcow)| duplicated(farmcow,  fromLast=TRUE), 1, 0)) %>%
  #filter(farmcow.dup == 1) #102 obs


####################
# Ready data frame #
####################
Three <- df.three #4506 obs of 64v
#TWoParity <- df.three_twoparity #102 obs of 65v
rm(list = ls(pattern = "df"))
rm(list = ls(pattern = "all_"))
```

# Distribution - Univariable
```{r, warning=FALSE}
#################
#  Descriptive  #
#################
# Number of cows in this study -> 4506 cows
nrow(Three)

# Number of cows in the farm
Three$FarmNo <- as.factor(Three$FarmNo)
ggplot(data=Three, aes(x=fct_rev(fct_infreq(FarmNo)))) +
  geom_bar(stat="count", fill="orange") +
  stat_count(geom="text", size=3, aes(label=..count..)) +
  theme_classic() +
  theme(panel.border = element_blank(), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  ggtitle("Number of Cows in Each Farm") +
  xlab("Farm ID") +
  ylab("#cows")

### Add variable CowNo = number of cows in a farm
df.cowno <- data.frame(table(Three$FarmNo))
colnames(df.cowno)[colnames(df.cowno) == "Var1"] <- "FarmNo"
colnames(df.cowno)[colnames(df.cowno) == "Freq"] <- "CowNo"
mean(df.cowno$CowNo)

# Average farm size
mean(df.cowno$CowNo)
quantile(df.cowno$CowNo, c(0.25, 0.5, 0.75))

### Number of cows in each farm
Three <- merge(Three, df.cowno, by = c('FarmNo'), sort = F) 
Three <- Three %>%
  relocate(CowNo, .after = FarmNo) #4673 obs 65v

Three <- merge(Three, df.cowno, by = c('FarmNo'))
Three <- Three %>%
  relocate(CowNo, .after = FarmNo) #4724 obs 65v
Three$CowNo.x <- NULL
Three$CowNo.y <- NULL
```

## General Info and reproduction parameters
```{r, warning=FALSE}
# Number of cows in each calving season
ggplot(data=Three, aes(x=factor(CalvingSeason))) +
  geom_bar(stat="count", fill="darkred") +
  stat_count(geom="text", size=5, aes(label=..count..)) +
  ggtitle("Number of Cows in Calving Seasons") +
  theme_classic() +
  xlab("Calving Seasons")

# Number of cows in each lactation
mean(Three$Lactation)
summary(Three$Lactation)

Three$Lactation <- as.factor(Three$Lactation)
ggplot(data=Three, aes(x=factor(Lactation)))+
  geom_bar(stat="count", fill="skyblue") +
  stat_count(geom="text", size=3, aes(label=..count..)) +
  ggtitle("Lactation Distribution") +
  theme_classic() +
  xlab("Lactation") +
  ylab("#cows")

Three$ad_Lactation <- as.factor(Three$ad_Lactation)
ggplot(data=Three, aes(x=factor(ad_Lactation)))+
  geom_bar(stat="count", fill="skyblue") +
  stat_count(geom="text", size=5, aes(label=..count..)) +
  ggtitle("Number of Cows in 4 Lactation Categories") +
  theme_classic() +
  xlab("Lactation, 4 means 4+") +
  ylab("#cows")

# Number of cows vs number of AI
Three$Last_AI <- as.factor(Three$Last_AI)
ggplot(data=Three, aes(x=factor(Last_AI))) +
  geom_bar(stat="count", fill="yellow") +
  stat_count(geom="text", size=2, aes(label=..count..)) +
  ggtitle("Number of Cows and Number of AI") + 
  xlab("Number of AI") +
  theme_classic()

# Average number of AI
summary(Three$Last_AI)
mean(Three$Last_AI, na.rm = TRUE)

# Culled cows during the cohort
table(Three$Culled_Status)
ggplot(data=Three, aes(x=cull.calving)) +
  geom_histogram(breaks=seq(100, 200, by=2.5),
                 fill="red") +
  #facet_wrap(Three$FarmNo) +
  ggtitle("Days from Calving to Culled") +
  xlab("DFC") +
  ylab("#cows") +
  theme_classic()
# Average DFC that cows were culled
mean(Three$cull.calving, na.rm = TRUE)
quantile(Three$cull.calving, c(0, 0.25, 0.5, 0.75, 1), na.rm = T)

# Days from calving to reproduction events (DFC_CLA)
ggplot(data=Three, aes(x=DFC_CLA)) +
  geom_histogram(breaks=seq(0, 200, by=5),
                 fill="green") +
  #facet_wrap(Three$FarmNo) +
  ggtitle("Days from Calving to First Cycle") +
  xlab("DFC") +
  ylab("#cows") +
  theme_classic()
# Average DFC_CLA
mean(Three$DFC_CLA, na.rm = T)
quantile(Three$DFC_CLA, c(0, 0.25, 0.5, 0.75, 1), na.rm = T)

# DFCFirstHeat
ggplot(data=Three, aes(x=DFCFirstHeat)) +
  geom_histogram(breaks=seq(0, 250, by=5),
                 fill="lightgreen") +
  #facet_wrap(Three$FarmNo) +
  ggtitle("Days from Calving to First Heat") +
  xlab("DFC") +
  ylab("#cows") +
  theme_classic()
# Average DFCFirstHeat
mean(Three$DFCFirstHeat, na.rm = T)
quantile(Three$DFCFirstHeat, c(0, 0.25, 0.5, 0.75, 1), na.rm = T)

#DaysToFirstIns
ggplot(data=Three, aes(x=DaysToFirstIns)) +
  geom_histogram(breaks=seq(0, 200, by=5),
                 fill="green") +
  #facet_wrap(Three$FarmNo) +
  ggtitle("Days from Calving to First Insemination") +
  xlab("DFC") +
  ylab("#cows") +
  theme_classic()
# Average DaysToFirstIns
mean(Three$DaysToFirstIns, na.rm = T)
quantile(Three$DaysToFirstIns, c(0, 0.25, 0.5, 0.75, 1), na.rm = T)

#DaysToLastIns
ggplot(data=Three, aes(x=DaysToLastIns)) +
  geom_histogram(breaks=seq(0, 620, by=15),
                 fill="purple") +
  #facet_wrap(Three$FarmNo) +
  ggtitle("Days from Calving to Last Insemination") +
  xlab("DFC") +
  ylab("#cows") +
  theme_classic()

#Number of AIs
Three$Last_AI <- as.factor(Three$Last_AI)
ggplot(data=Three, aes(x=factor(Last_AI)))+
  geom_bar(stat="count", fill="pink") +
  stat_count(geom="text", size=3, aes(label=..count..)) +
  ggtitle("Number of AI Distribution") +
  theme_classic() +
  xlab("#AI") +
  ylab("#cows")
Three$Last_AI <- as.numeric(Three$Last_AI)
mean(Three$Last_AI, na.rm = T)
```

## Milk parameters
```{r}
## PeakDim
summary(Three$PeakDim)
ggplot(data=Three, aes(x=PeakDim)) +
  geom_histogram(breaks=seq(0, 640, by=20),
                 fill="royalblue1") +
  facet_wrap(Three$ad_Lactation, ncol = 4) +
  ggtitle("DFC where highest peak yield was achieved") +
  xlab("DFC") +
  ylab("#cows") +
  theme_classic()

## AvgMY60
summary(Three$AvgMY60)
ggplot(data=Three, aes(x=AvgMY60)) +
  geom_histogram(breaks=seq(0, 70, by=2.5),
                 fill="lightblue") +
  facet_wrap(Three$ad_Lactation, ncol = 4) +
  ggtitle("Average milk yield within 60 DFC") +
  xlab("Milk yield (L)") +
  ylab("#cows") +
  theme_classic()

## SumMY60
summary(Three$SumMY60)
ggplot(data=Three, aes(x=SumMY60)) +
  geom_histogram(breaks=seq(300, 4400, by=100),
                 fill="lightblue") +
  facet_wrap(Three$ad_Lactation, ncol = 4) +
  ggtitle("Cumulative milk yield within 60 DFC") +
  xlab("Cumulative milk yield (L)") +
  ylab("#cows") +
  theme_classic() +
  theme(axis.text.x = element_text(angle =90))
```

## Ketosis parameters
```{r}
#AvgKeto20_atleast10
summary(Three$AvgKeto20_atleast10)


```
