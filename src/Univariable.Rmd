---
title: "Univariable"
author: "Kelly Chin"
date: "2/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library, warning=FALSE, message = FALSE}
library(readxl)
library(tidyr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(reader)
library(lubridate)
```

```{r, warning=FALSE}
#########################
#   Merge Reproduction  #
#########################
# Merge reproduction data from 38 farms
# empty the data frame first
all_farm_raw <- data.frame()

for(i in 1001:1038){
  # create the excel file name base on the input i
  filename <- paste("C:/Data/",i,", All Data, Proc, June 2020.xlsx", sep = "")

  # load the sheets within the same excel file (the same farm)
  df.calving <- read_excel(filename, sheet = "Calving")
  df.cowinfo <- read_excel(filename, sheet = "CowInfo")
  # change the column name of cowinfo (CowID -> CowId)
  colnames(df.cowinfo)[colnames(df.cowinfo)=="CowID"] <- "CowId"
  # change the column BirthDate into character
  df.cowinfo$BirthDate <- as.character(df.cowinfo$BirthDate)
  df.culldata <- read_excel(filename, sheet = "CullData")
  df.calving <- read_excel(filename, sheet = "Calving")
  df.insemination <- read_excel(filename, sheet = "Insemination")
  df.pregnancy <- read_excel(filename, sheet = "Pregnancy")

  # merge the data of different sheets within the same farm
  df.farm <- merge(df.cowinfo, df.calving, by = "CowId", all.x=TRUE, all.y=TRUE) %>%
    merge(df.culldata, by = "CowId", all.x = TRUE, all.y=TRUE) %>%
    merge(df.insemination, by = "CowId", all.x=TRUE, all.y=TRUE) %>%
    merge(df.pregnancy, by = "CowId", all.x=TRUE, all.y=TRUE)

  # append all the merged data into the master final data table
  all_farm_raw <- bind_rows(all_farm_raw, df.farm)
}
rm(list=ls(pattern="df"))
summary(all_farm_raw)

# Delete all the rows that without calving date
all_farm <- subset(all_farm_raw, !is.na(all_farm_raw$CalvingDate))
df.cow <- all_farm %>%
  distinct(FarmNo, CowId)
rm(all_farm_raw)
nrow(all_farm)
str(all_farm)
summary(all_farm)
all_farm$BirthDate <- as.Date(all_farm$BirthDate)

# change weird date signs to NAs #
all_farm$EEDDate <- as.Date(all_farm$NextIns)
all_farm$EEDDate[all_farm$EEDDate == "1899-12-31"] <- NA
all_farm$NextIns <- as.Date(all_farm$NextIns)
all_farm$NextIns[all_farm$NextIns == "1899-12-31 00:00:00"] <- NA
all_farm$PregDate.x <- as.Date(all_farm$PregDate.x)
all_farm$PregDate.x[all_farm$PregDate.x == "1899-12-31 00:00:00"] <- NA
all_farm$AbortionDate <- as.Date(all_farm$AbortionDate)
all_farm$AbortionDate[all_farm$AbortionDate == "1899-12-31 00:00:00"] <- NA
summary(all_farm)
summary(all_farm$CohortExitDate)
```

# Reproduction
```{r, warning=FALSE}
###########################################
# select reproduction events of interests #
###########################################
df.preg <- all_farm %>%
  select(FarmNo, CowId, BirthDate, CalvingDate, Lactation, CullDate, InsDate, InsNumber, NextIns, PregDate.x, PregDate.y, DeterminationType, AbortionDate, DaysToAbort)
summary(df.preg)
str(df.preg)
#Remove rows with FarmNo = NA
df.preg1 <- df.preg[!is.na(df.preg$FarmNo), ]
summary(df.preg1)
# number of cows 
df.cow <- df.preg1 %>%
  distinct(FarmNo, CowId)
```


