---
title: "Model building"
author: "Kelly Chin"
date: "3/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R libraries
```{r}
library(readxl)
library(performance)
library(survival)
library(survminer)
library(tidyr)
library(gtsummary)
library(coxme)
library(lme4)
library(nlme)
library(ggplot2)
```

# Data
```{r}
Three <- read_excel("../data/raw/Three.xlsx")
#Three$CalvingYear <- as.factor(ifelse(Three$CalvingYear == 2018, 1, 2))
```

# Linear Model
```{r}
mod1 <- lm(Three$DaysToFirstHeat~Three$AvgKeto20_atleast10 + Three$MaxKetoDFC20 + factor(Three$ad_Lactation) + Three$PeakDFC + Three$AvgMY20 + Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1)
plot(mod1)

mod1_AvgMY <- lm(Three$DaysToFirstHeat~Three$AvgKeto20_atleast10 + factor(Three$ad_Lactation) + Three$PeakDFC +Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1_AvgMY)

anova(mod1, mod1_AvgMY)

mod1.1 <- lm(Three$DaysToFirstHeat~Three$AvgKeto20_atleast10 + Three$Lactation + Three$PeakDFC + Three$AvgMY20 + Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1.1)

anova(mod1, mod1.1)

# Times AvgKeto20_atleast10 to 100 for easier quantify the one unit change of ketosis value and the influence on fertiliy
Three <- Three %>%
  mutate(AvgKeto20_100 = 100*AvgKeto20_atleast10)

mod1.100 <- lm(DaysToFirstHeat~AvgKeto20_100 + MaxKetoDFC20 + factor(ad_Lactation) + PeakDFC + AvgMY20 + CalvingSeason + factor(FarmNo), data = Three)
summary(mod1.100)
    
```

# Log transformation (1)
```{r}
Three.log <- Three %>%
  mutate(log.DFC_CLA = log(DFC_CLA),
         log.DaysToFirstHeat = log(DaysToFirstHeat), 
         log.DaysToFirstIns = log(DaysToFirstIns), 
         log.AvgKeto20 = log(AvgKeto20_atleast10), 
         log.AvgKeto60 = log(AvgKeto60_atleast10)) #4327 obs of 71v

# log transform the outcome variable
mod1.log <- lm(log.DaysToFirstHeat~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo, data = Three.log)
summary(mod1.log)
#plot(mod1.log)

# FarmNo and interaction with ketosis
mod1.log.int <- lm(log.DaysToFirstHeat~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo:AvgKeto20_atleast10, data = Three.log)
summary(mod1.log.int)
#plot(mod1.log.int)

anova(mod1.log, mod1.log.int)
```

# Log transformation (2)
```{r}
# log transform both outcome and explantory variables
mod2.log <- lm(log.DaysToFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo, data = Three.log)
summary(mod2.log)
plot(mod2.log)

# FarmNo and interaction with ketosis
mod2.log.int <- lm(log.DaysToFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo):log.AvgKeto20, data = Three.log)
summary(mod2.log.int)
plot(mod2.log.int)

compare_performance(mod2.log, mod2.log.int, rank = TRUE)


mod2.log1 <- lm(log.DaysToFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.log)
mod2.log2 <- lm(log.DaysToFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.log)
summary(mod2.log1)
summary(mod2.log2)

compare_performance(mod2.log1, mod2.log2, rank = TRUE)
```

# Generalized Linear Model
```{r}
glm.mod1 <- glm(DaysToFirstHeat~AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, family = "gaussian", data = Three)

glm.log1 <- glm(log.DaysToFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, data = Three.log, family = "gaussian")
summary(glm1.log) # the same as linear model
glm1.log$aic

anova(glm.mod1, glm.log1, test = "Chisq")
```

# Survival regression
```{r}
## Example
#df.surv1 <- survfit(Surv(rDFC, KetoCow)~ad_Lactation, data=Three)
#summary(df.surv1)
#plot(df.surv1, main="Cumulative Survival Function", lty=c(1, 2, 3, 4), xlab="Day after calving (day)", ylab="Probability")
#legend(x=0, y=0.6)
```
```{r}
survival <- Three %>%
  mutate(FirstHeat = ifelse(is.na(Three$DaysToFirstHeat), 0, 1)) %>%
  mutate(FirstAI = ifelse(is.na(Three$DaysToFirstIns), 0, 1)) %>%
  mutate(KetoStatus20 = ifelse(Three$AvgKeto20_atleast10 >= 0.08, 1, 0)) %>%
  mutate(KetoQua = ifelse(Three$AvgKeto20_atleast10 >= 0.076, 4, 
                          ifelse(Three$AvgKeto20_atleast10 >= 0.061 & Three$AvgKeto20_atleast10 < 0.076, 3, 
                                 ifelse(Three$AvgKeto20_atleast10 >= 0.055 & Three$AvgKeto20_atleast10 < 0.061, 2, 
                                        ifelse(Three$AvgKeto20_atleast10 < 0.055, 1, NA))))) %>%
  mutate(KetoMaxDay = ifelse(Three$MaxKetoDFC20 >= 17, 4, 
                             ifelse(Three$MaxKetoDFC20 >= 12 & Three$MaxKetoDFC20 < 17, 3,
                                    ifelse(Three$MaxKetoDFC20 >= 8 & Three$MaxKetoDFC20 < 12, 2, 
                                           ifelse(Three$MaxKetoDFC20 <8, 1, NA))))) %>%
  mutate(KetoMaxDay2 = ifelse(Three$MaxKetoDFC20 >= 12, 1, 0))

summary(survival)
survival$FarmNo <- as.factor(survival$FarmNo)
survival$CalvingSeason <- as.factor(survival$CalvingSeason)
survival$KetoStatus20 <- as.factor(survival$KetoStatus20)
survival$ad_Lactation <- as.factor(survival$ad_Lactation)
survival$KetoQua <- as.factor(survival$KetoQua)
```

# Descriptive statistics
```{r}
# DaysToFirstHeat
ggplot(data=survival, aes(x=DaysToFirstHeat))+
  geom_histogram(breaks=seq(0, 250, by=5),
                 fill="lightblue")+
  #facet_wrap(Three$FarmNo) +
  ggtitle("Time from Calving to First Heat")+
  xlab("day")+
  ylab("#cows")+
  theme_classic()
summary(survival$DaysToFirstHeat)
var(survival$DaysToFirstHeat)
sd(survival$DaysToFirstHeat)

# BOXPLOT- DaysToFirstHeat vs. FarmNo
plot(survival$DaysToFirstHeat ~ survival$AvgKeto20_100)
boxplot(survival$DaysToFirstHeat ~ survival$FarmNo, xlab = "Farm ID", ylab = "Time from calving to first heat")
ggplot(data = survival, aes(x = FarmNo, y = DaysToFirstHeat)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Days from calving to first heat") +
  theme(axis.text.x = element_text(angle = 90))
  
# BOXPLOT- AvgKeto20_100 vs. FarmNo
boxplot(survival$AvgKeto20_100 ~ survival$FarmNo)
ggplot(data = survival, aes(x = FarmNo, y = AvgKeto20_100)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Average milk BHB*100 (mmol/L)") +
  theme(axis.text.x = element_text(angle = 90))


boxplot(survival$DaysToFirstHeat ~ survival$ad_Lactation)
ggplot(data = survival, aes(x = ad_Lactation, y = DaysToFirstHeat)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Parity", y = "Days from calving to first heat")
```

# Survival curves (DaysToFirstHeat)
```{r}
surv.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ 1, data = survival)
plot(surv.heat, main = "Cumulatvie survival time from calving to first heat",
     ylab = "Cumulative survival probability",
     xlab = "Time (days from calving to first heat)")
print(surv.heat)
ggsurvplot(surv.heat, data = survival,
           surv.median.line = "hv",
           xlab = "Time (days from calving to first heat",
           legend.title = "Cumulative survival time to first heat",
           pval = TRUE,
           conf.int = TRUE,
           risk.table = TRUE,
           tables.height = 0.2,
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv1.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ ad_Lactation, data=survival)
print(surv1.heat)
ggsurvplot(surv1.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Parity", 
           legend.labs = c("1", "2", "3", "4+"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

# Change font size, style and color
#++++++++++++++++++++++++++++++++++++
if (FALSE) {
# Change font size, style and color at the same time
ggsurvplot(surv1.heat, data = survival,  main = "Survival curve",
   font.main = c(16, "bold", "darkblue"),
   font.x = c(14, "bold.italic", "red"),
   font.y = c(14, "bold.italic", "darkred"),
   font.tickslab = c(12, "plain", "darkgreen"))
}

surv2.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoStatus20, data=survival)
summary(surv2.heat)
print(surv2.heat) #risk table
ggsurvplot(surv2.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Ketosis status within 20 DFC", 
           legend.labs = c("Avg. BHB < 0.08", "Avg. BHB ≥ 0.08"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv3.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoQua, data=survival)
print(surv3.heat)
ggsurvplot(surv3.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Avg. BHB within 20 DFC (mmol/L)", 
           legend.labs = c("<0.055", "0.055-0.061", "0.061-0.076", "≥0.076"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv4.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoMaxDay, data=survival)
print(surv4.heat)
ggsurvplot(surv4.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Day when BHB reached maximum within 20 DFC (DFC)", 
           legend.labs = c("< 8 days", "8-12", "12-17", "17-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv5.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoMaxDay2, data=survival)
print(surv5.heat)
ggsurvplot(surv5.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Day when BHB reached maximum within 20 DFC (DFC)", 
           legend.labs = c("<12", "12-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv6.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ CalvingYear, data = survival)
print(surv6.heat)
ggsurvplot(surv6.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Calving Year", 
           legend.labs = c("2018", "2019"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv7.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ CalvingSeason, data = survival)
print(surv7.heat)
ggsurvplot(surv7.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Calving Seasons", 
           legend.labs = c("Fall", "Spring", "Summer", "Winter"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())
```

# Cox hazard proportional regression - First Heat vs ketosis
```{r} 
# Univariate Cox regression
cox.ketostatus <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ KetoStatus20, data = survival)
cox.ketostatus
plot(survfit(cox.avgketo, conf.int = TRUE, data = survival))

cox.avgketo <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100, data = survival)
cox.avgketo

cox.maxketo20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ MaxKeto20, data = survival)
cox.maxketo20

cox.MaxKetoDFC20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ MaxKetoDFC20, data = survival)
cox.MaxKetoDFC20

cox.nhighketo20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ nHighKeto20, data = survival)
cox.nhighketo20

cox.ketodur20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ KetoDur20, data = survival)
cox.ketodur20
```

# Cox hazard proportional regression - First Heat vs Farm Info
```{r}
# Univariate Cox regression
cox.lactation <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ ad_Lactation, data = survival)
cox.lactation

cox.lactation1 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ Lactation, data = survival)
cox.lactation1

cox.farmno <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ FarmNo, data = survival)
cox.farmno

cox.calvingseason <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ CalvingSeason, data = survival)
cox.calvingseason

cox.peakdfc <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ PeakDFC, data = survival)
cox.peakdfc

cox.peakmy <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ PeakMY, data = survival)
cox.peakmy

cox.avgmy20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgMY20, data = survival)
cox.avgmy20

cox.summy20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ SumMY20, data = survival)
cox.summy20
```

## Multiple covariates at once
```{r}
# Multiple covariates at once for univariate coxph
covariates <- c("AvgKeto20_atleast10", "MaxKetoDFC20", #"nHighKeto20", "KetoDur20",
                #"KetoStatus20", "KetoQua", "KetoMaxDay", "KetoMaxDay2", 
                #"PeakDFC", 
                "AvgMY20", "SumMY20",
                "ad_Lactation", "CalvingYear", "CalvingSeason", 
                "FarmNo", "Lactation")

univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(DaysToFirstHeat, FirstHeat) ~', x)), 
                        simplify = FALSE)

univ_formulas <- vector()
for (x in covariates) {
  univ_formulas <- c(univ_formulas, paste('Surv(DaysToFirstHeat, FirstHeat) ~', x))
}

univ_models <- lapply(univ_formulas, function(x)(coxph(as.formula(x), data = survival)))

coxph(as.formula(univ_formulas[5]), data = survival)
univ_models

summary(survival)
## Extract data
univ_results <- lapply(univ_models, 
                       function(x){
                         x <- summary(x)
                         p.value <- signif(x$wald["pvalue"], digits = 2)
                         wald.test <- signif(x$wald["test"], digits = 2)
                         beta <- signif(x$coef[1], digits = 2); #coefficient beta
                         HR <- signif(x$coef[2], digits = 2);
                         HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                         HR.confint.upper <- signif(x$conf.int[,"upper .95"], 2)
                         HR <- paste0(HR, " (",
                                      HR.confint.lower, "-", HR.confint.upper, ")")
                         res <- c(beta, HR, wald.test, p.value)
                         names(res) <- c("beta", "HR (95% CI for HR)", 
                                         "wald.test", "p.value")
                         return(res)
                         #return(exp(cbind(coef(x), confint(x))))
                       })
x <- univ_models[[3]]
summary(x)
p.value <- signif(summary(x)$wald[3], digits = 5)
str(summary(x))

res <- t(as.data.frame(univ_results, check.names = FALSE))

```

# Cox PH model with different milk parameters
```{r}
cox0 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~1, data=survival)
cox10 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100, data = survival)

cox1 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox1

cox2 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakMY + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox2
anova(cox1, cox2)

drop1(cox2) # model 2 without dropping any parameter is the best
MASS::stepAIC(cox2)

plot(survival$PeakMY, survival$AvgMY60)
cor(survival$PeakMY, survival$AvgMY60) # 0.9, highly correlated variables

# change AvgMY60 to PeakDFC
cox3 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakMY + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox3
drop1(cox3) # model 3 without dropping any parameter is the best
plot(survival$PeakMY, survival$PeakDFC)
cor(survival$PeakDFC, survival$PeakMY) # not highly correlated

anova(cox2, cox3) # model 2 is better than model 3, but model 2 has multicollinearity problem

# only use one milk variable (PeakMY)
cox4 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakMY + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox4

anova(cox2, cox4) # model 2 is better than model 4
anova(cox3, cox4) # model 3 is slightly better than model 4

# only use AvgMY60
cox5 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox5 # AvgMY60 is not significant in the model, can be removed
```

# Coxme model with random effect
```{r}
coxme1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme1
anova(cox1, coxme1)
coxme2 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme2

coxme1$loglik
coxme2$loglik
AIC(coxme1)
AIC(coxme2)

#########################
##  Check Interaction  ##
#########################
coxme3 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + AvgKeto20_100:ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme3
anova(coxme2, coxme3)
# don't need to consider interaction between ketosis and parity

coxme4 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + AvgKeto20_100:PeakDFC + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme4
anova(coxme2, coxme4)
# don't need to consider interaction between ketosis and peak day of highest milk yield
```

# model check
```{r}
resid.cox10 <- resid(cox10, type = "martingale")
resid.cox0 <- resid(cox0, type = "martingale")
#par(mfrow = c(1,2))
plot(survival$AvgKeto20_100, resid.cox0)
lines(lowess(survival$AvgKeto20_100, resid.cox0))
plot(log(survival$AvgKeto20_100), resid.cox0)
lines(lowess(log(survival$AvgKeto20_100), resid.cox0))

plot(survival$AvgKeto20_100, resid.cox10)
lines(lowess(survival$AvgKeto20_100, resid.cox10))
plot(log(survival$AvgKeto20_100), resid.cox10)
lines(lowess(log(survival$AvgKeto20_100), resid.cox10))
```

# Coxme model with random effect
```{r}
cox0 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~1, data=survival)
cox10 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100, data = survival)
summary(cox10)

cox1 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
summary(cox1)

coxme1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme1
anova(cox1, coxme1)
coxme2 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme2

coxme1$loglik
coxme2$loglik
AIC(coxme1)
AIC(coxme2)
```

```{r}
coxme1.keto <- coxme(Surv(DaysToFirstHeat, FirstHeat)~KetoStatus20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme1.keto

```

# Martingale residuals: check linearity
```{r}
# check AvgKeto20_100 in coxme1
coxme1.keto <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme1 <- resid(coxme1.keto, type = "martingale")
plot(survival$AvgKeto20_100, res.coxme1, main = "Residual of AvgKeto20_100")
lines(lowess(survival$AvgKeto20_100, res.coxme1), col = "red")

# check PeakDFC in coxme1
coxme1.peakdfc <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme1.peakdfc <- resid(coxme1.peakdfc, type = "martingale")
plot(survival$PeakDFC, res.coxme1.peakdfc, main = "Residual of PeakDFC")
lines(lowess(survival$PeakDFC, res.coxme1.peakdfc), col = "red")
```

```{r}
# check AvgKeto20_100 in coxme2
coxme2.keto <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2 <- resid(coxme2.keto, type = "martingale")
plot(survival$AvgKeto20_100, res.coxme2, main = "Residual of AvgKeto20_100")
lines(lowess(survival$AvgKeto20_100, res.coxme2), col = "red")

# check PeakDFC in coxme2
coxme2.peakdfc <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2.peakdfc <- resid(coxme2.peakdfc, type = "martingale")
plot(survival$PeakDFC, res.coxme2.peakdfc, main = "Residual of PeakDFC")
lines(lowess(survival$PeakDFC, res.coxme2.peakdfc), col = "red")
```

```{r}
coxme2.lact <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2.lact <- resid(coxme2.lact, type = "martingale")
plot(survival$ad_Lactation, res.coxme2.lact, main = "Residual of ad_Lactation")
lines(lowess(survival$ad_Lactation, res.coxme2.lact), col = "red")
```

# Df Beta residuals
```{r}
resid.coxme1 <- resid(coxme1, type = "dfbeta")
plot(survival$AvgKeto20_100, resid.coxme1[,1], ylab = "dfbeta for AvgKeto20_100")
plot(survival$ad_Lactation, resid.coxme1[,2], ylab="dfbeta for ad_Lactation")
resid.coxme1[,1]
```

```{r}
## First Heat
df.cox1.heat <- coxph(Surv(DaysToFirstHeat, FirstHeat) ~ ad_Lactation + AvgKeto20_atleast10 + MaxKetoDFC20 + PeakDFC + AvgMY20 + CalvingSeason  + factor(FarmNo), data = survival)
summary(df.cox1.heat)

ggsurvplot(survfit(df.cox1.heat), data = survival, color= "#2E9FDF", ggtheme = theme_minimal())

ggsurv <- ggsurvplot(survfit(df.cox1.heat), data = survival, 
                     fun = "cumhaz", conf.int = TRUE, 
                     risk.table = TRUE, risk.table.col = "strata", 
                     ggtheme = theme_bw())
curv_facet <- ggsurv$plot + facet_grid(AvgKeto20_atleast10 ~ PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo))
curv_facet
```

# Cox hazard proportional regression - First AI
```{r}
## First AI
df.cox1.ai <- coxph(Surv(DaysToFirstIns, FirstAI) ~ AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = survival)
summary(df.cox1.ai)

ggsurvplot(survfit(df.cox1.ai), data = survival, color= "#2E9FDF", ggtheme = theme_minimal())
```
