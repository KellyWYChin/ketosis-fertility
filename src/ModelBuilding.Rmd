---
title: "Model building"
author: "Kelly Chin"
date: "3/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R libraries
```{r}
library(readxl)
library(performance)
library(survival)
library(survminer)
library(tidyr)
library(gtsummary)
library(coxme)
library(lme4)
library(nlme)
```

# Data
```{r}
Three <- read_excel("../data/raw/Three.xlsx")
#Three$CalvingYear <- as.factor(ifelse(Three$CalvingYear == 2018, 1, 2))

```

# Linear Model
```{r}
mod1 <- lm(Three$DFCFirstHeat~Three$AvgKeto20_atleast10 + Three$MaxKetoDFC20 + factor(Three$ad_Lactation) + Three$PeakDFC + Three$AvgMY20 + Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1)
plot(mod1)

mod1_AvgMY <- lm(Three$DFCFirstHeat~Three$AvgKeto20_atleast10 + factor(Three$ad_Lactation) + Three$PeakDFC +Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1_AvgMY)

anova(mod1, mod1_AvgMY)

mod1.1 <- lm(Three$DFCFirstHeat~Three$AvgKeto20_atleast10 + Three$Lactation + Three$PeakDFC + Three$AvgMY20 + Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1.1)

anova(mod1, mod1.1)

# Times AvgKeto20_atleast10 to 100 for easier quantify the one unit change of ketosis value and the influence on fertiliy
Three <- Three %>%
  mutate(AvgKeto20_100 = 100*AvgKeto20_atleast10)

mod1.100 <- lm(DFCFirstHeat~AvgKeto20_100 + MaxKetoDFC20 + factor(ad_Lactation) + PeakDFC + AvgMY20 + CalvingSeason + factor(FarmNo), data = Three)
summary(mod1.100)
    
```

# Log transformation (1)
```{r}
Three.log <- Three %>%
  mutate(log.DFC_CLA = log(DFC_CLA),
         log.DFCFirstHeat = log(DFCFirstHeat), 
         log.DaysToFirstIns = log(DaysToFirstIns), 
         log.AvgKeto20 = log(AvgKeto20_atleast10), 
         log.AvgKeto60 = log(AvgKeto60_atleast10)) #4327 obs of 71v

# log transform the outcome variable
mod1.log <- lm(log.DFCFirstHeat~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo, data = Three.log)
summary(mod1.log)
#plot(mod1.log)

# FarmNo and interaction with ketosis
mod1.log.int <- lm(log.DFCFirstHeat~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo:AvgKeto20_atleast10, data = Three.log)
summary(mod1.log.int)
#plot(mod1.log.int)

anova(mod1.log, mod1.log.int)
```

# Log transformation (2)
```{r}
# log transform both outcome and explantory variables
mod2.log <- lm(log.DFCFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo, data = Three.log)
summary(mod2.log)
plot(mod2.log)

# FarmNo and interaction with ketosis
mod2.log.int <- lm(log.DFCFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo):log.AvgKeto20, data = Three.log)
summary(mod2.log.int)
plot(mod2.log.int)

compare_performance(mod2.log, mod2.log.int, rank = TRUE)


mod2.log1 <- lm(log.DFCFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.log)
mod2.log2 <- lm(log.DFCFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.log)
summary(mod2.log1)
summary(mod2.log2)

compare_performance(mod2.log1, mod2.log2, rank = TRUE)
```

# Generalized Linear Model
```{r}
glm.mod1 <- glm(DFCFirstHeat~AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, family = "gaussian", data = Three)

glm.log1 <- glm(log.DFCFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, data = Three.log, family = "gaussian")
summary(glm1.log) # the same as linear model
glm1.log$aic

anova(glm.mod1, glm.log1, test = "Chisq")
```

# Survival regression
```{r}
## Example
#df.surv1 <- survfit(Surv(rDFC, KetoCow)~ad_Lactation, data=Three)
#summary(df.surv1)
#plot(df.surv1, main="Cumulative Survival Function", lty=c(1, 2, 3, 4), xlab="Day after calving (day)", ylab="Probability")
#legend(x=0, y=0.6)
```
```{r}
Three.surv <- Three %>%
  mutate(FirstHeat = ifelse(is.na(Three$DFCFirstHeat), 0, 1)) %>%
  mutate(FirstAI = ifelse(is.na(Three$DaysToFirstIns), 0, 1)) %>%
  mutate(KetoStatus20 = ifelse(Three$AvgKeto20_atleast10 >= 0.08, 1, 0)) %>%
  mutate(KetoQua = ifelse(Three$AvgKeto20_atleast10 >= 0.076, 4, 
                          ifelse(Three$AvgKeto20_atleast10 >= 0.061 & Three$AvgKeto20_atleast10 < 0.076, 3, 
                                 ifelse(Three$AvgKeto20_atleast10 >= 0.055 & Three$AvgKeto20_atleast10 < 0.061, 2, 
                                        ifelse(Three$AvgKeto20_atleast10 < 0.055, 1, NA))))) %>%
  mutate(KetoMaxDay = ifelse(Three$MaxKetoDFC20 >= 17, 4, 
                             ifelse(Three$MaxKetoDFC20 >= 12 & Three$MaxKetoDFC20 < 17, 3,
                                    ifelse(Three$MaxKetoDFC20 >= 8 & Three$MaxKetoDFC20 < 12, 2, 
                                           ifelse(Three$MaxKetoDFC20 <8, 1, NA))))) %>%
  mutate(KetoMaxDay2 = ifelse(Three$MaxKetoDFC20 >= 12, 1, 0))

summary(Three.surv)
Three.surv$FarmNo <- as.factor(Three.surv$FarmNo)
Three.surv$CalvingSeason <- as.factor(Three.surv$CalvingSeason)
Three.surv$KetoStatus20 <- as.factor(Three.surv$KetoStatus20)
Three.surv$ad_Lactation <- as.factor(Three.surv$ad_Lactation)
Three.surv$KetoQua <- as.factor(Three.surv$KetoQua)
```

# Survival curves (DFCFirstHeat)
```{r}
surv.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ 1, data = Three.surv)
plot(surv.heat, main = "Cumulatvie survival time from calving to first heat",
     ylab = "Cumulative survival probability",
     xlab = "Time (days from calving to first heat)")
print(surv.heat)
ggsurvplot(surv.heat, data = Three.surv,
           surv.median.line = "hv",
           xlab = "Time (days from calving to first heat",
           legend.title = "Cumulative survival time to first heat",
           pval = TRUE,
           conf.int = TRUE,
           risk.table = TRUE,
           tables.height = 0.2,
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv1.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ ad_Lactation, data=Three.surv)
print(surv1.heat)
ggsurvplot(surv1.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Parity", 
           legend.labs = c("1", "2", "3", "4+"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

# Change font size, style and color
#++++++++++++++++++++++++++++++++++++
if (FALSE) {
# Change font size, style and color at the same time
ggsurvplot(surv1.heat, data = Three.surv,  main = "Survival curve",
   font.main = c(16, "bold", "darkblue"),
   font.x = c(14, "bold.italic", "red"),
   font.y = c(14, "bold.italic", "darkred"),
   font.tickslab = c(12, "plain", "darkgreen"))
}

surv2.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ KetoStatus20, data=Three.surv)
summary(surv2.heat)
print(surv2.heat) #risk table
ggsurvplot(surv2.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Ketosis status within 20 DFC", 
           legend.labs = c("Avg. BHB < 0.08", "Avg. BHB ≥ 0.08"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv3.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ KetoQua, data=Three.surv)
print(surv3.heat)
ggsurvplot(surv3.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Avg. BHB within 20 DFC (mmol/L)", 
           legend.labs = c("<0.055", "0.055-0.061", "0.061-0.076", "≥0.076"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv4.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ KetoMaxDay, data=Three.surv)
print(surv4.heat)
ggsurvplot(surv4.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Day when BHB reached maximum within 20 DFC (DFC)", 
           legend.labs = c("< 8 days", "8-12", "12-17", "17-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv5.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ KetoMaxDay2, data=Three.surv)
print(surv5.heat)
ggsurvplot(surv5.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Day when BHB reached maximum within 20 DFC (DFC)", 
           legend.labs = c("<12", "12-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv6.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ CalvingYear, data = Three.surv)
print(surv6.heat)
ggsurvplot(surv6.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Calving Year", 
           legend.labs = c("2018", "2019"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv7.heat <- survfit(Surv(DFCFirstHeat, FirstHeat) ~ CalvingSeason, data = Three.surv)
print(surv7.heat)
ggsurvplot(surv7.heat, data=Three.surv,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Calving Seasons", 
           legend.labs = c("Fall", "Spring", "Summer", "Winter"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())
```

# Cox regression model
```{r}
coxph(Surv(DFCFirstHeat, FirstHeat) ~ KetoStatus20, data = Three.surv)
```

# Cox hazard proportional regression - First Heat vs ketosis
```{r}
# Univariate Cox regression
cox.ketostatus <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ KetoStatus20, data = Three.surv)
cox.ketostatus

cox.avgketo <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ AvgKeto20_atleast10, data = Three.surv)
cox.avgketo

cox.maxketo20 <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ MaxKeto20, data = Three.surv)
cox.maxketo20

cox.MaxKetoDFC20 <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ MaxKetoDFC20, data = Three.surv)
cox.MaxKetoDFC20

cox.nhighketo20 <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ nHighKeto20, data = Three.surv)
cox.nhighketo20

cox.ketodur20 <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ KetoDur20, data = Three.surv)
cox.ketodur20
```

# Cox hazard proportional regression - First Heat vs Farm Info
```{r}
# Univariate Cox regression
cox.lactation <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ ad_Lactation, data = Three.surv)
cox.lactation

cox.lactation1 <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ Lactation, data = Three.surv)
cox.lactation1

cox.farmno <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ FarmNo, data = Three.surv)
cox.farmno

cox.calvingseason <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ CalvingSeason, data = Three.surv)
cox.calvingseason

cox.peakdfc <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ PeakDFC, data = Three.surv)
cox.peakdfc

cox.peakmy <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ PeakMY, data = Three.surv)
cox.peakmy

cox.avgmy20 <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ AvgMY20, data = Three.surv)
cox.avgmy20

cox.summy20 <- coxph(Surv(DFCFirstHeat, FirstHeat)  ~ SumMY20, data = Three.surv)
cox.summy20
```

## Multiple covariates at once
```{r}
# Multiple covariates at once for univariate coxph
covariates <- c("AvgKeto20_atleast10", "MaxKetoDFC20", #"nHighKeto20", "KetoDur20",
                #"KetoStatus20", "KetoQua", "KetoMaxDay", "KetoMaxDay2", 
                #"PeakDFC", 
                "AvgMY20", "SumMY20",
                "ad_Lactation", "CalvingYear", "CalvingSeason", 
                "FarmNo", "Lactation")

univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(DFCFirstHeat, FirstHeat) ~', x)), 
                        simplify = FALSE)

univ_formulas <- vector()
for (x in covariates) {
  univ_formulas <- c(univ_formulas, paste('Surv(DFCFirstHeat, FirstHeat) ~', x))
}

univ_models <- lapply(univ_formulas, function(x)(coxph(as.formula(x), data = Three.surv)))

coxph(as.formula(univ_formulas[5]), data = Three.surv)
univ_models

summary(Three.surv)
## Extract data
univ_results <- lapply(univ_models, 
                       function(x){
                         x <- summary(x)
                         p.value <- signif(x$wald["pvalue"], digits = 2)
                         wald.test <- signif(x$wald["test"], digits = 2)
                         beta <- signif(x$coef[1], digits = 2); #coefficient beta
                         HR <- signif(x$coef[2], digits = 2);
                         HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                         HR.confint.upper <- signif(x$conf.int[,"upper .95"], 2)
                         HR <- paste0(HR, " (",
                                      HR.confint.lower, "-", HR.confint.upper, ")")
                         res <- c(beta, HR, wald.test, p.value)
                         names(res) <- c("beta", "HR (95% CI for HR)", 
                                         "wald.test", "p.value")
                         return(res)
                         #return(exp(cbind(coef(x), confint(x))))
                       })
x <- univ_models[[3]]
summary(x)
p.value <- signif(summary(x)$wald[3], digits = 5)
str(summary(x))

res <- t(as.data.frame(univ_results, check.names = FALSE))

```

```{r}
## First Heat
df.cox1.heat <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ ad_Lactation + AvgKeto20_atleast10 + MaxKetoDFC20 + PeakDFC + AvgMY20 + CalvingSeason  + factor(FarmNo), data = Three.surv)
summary(df.cox1.heat)

ggsurvplot(survfit(df.cox1.heat), data = Three.surv, color= "#2E9FDF", ggtheme = theme_minimal())

ggsurv <- ggsurvplot(survfit(df.cox1.heat), data = Three.surv, 
                     fun = "cumhaz", conf.int = TRUE, 
                     risk.table = TRUE, risk.table.col = "strata", 
                     ggtheme = theme_bw())
curv_facet <- ggsurv$plot + facet_grid(AvgKeto20_atleast10 ~ PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo))
curv_facet
```

# Cox hazard proportional regression - First AI
```{r}
## First AI
df.cox1.ai <- coxph(Surv(DaysToFirstIns, FirstAI) ~ AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.surv)
summary(df.cox1.ai)

ggsurvplot(survfit(df.cox1.ai), data = Three.surv, color= "#2E9FDF", ggtheme = theme_minimal())
```
