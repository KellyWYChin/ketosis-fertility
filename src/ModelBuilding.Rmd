---
title: "Model building"
author: "Kelly Chin"
date: "3/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R libraries
```{r}
library(readxl)
library(performance)
library(survival)
library(survminer)
library(coxme)
library(lme4)
```

# Linear Model
```{r}
Three <- read_excel("../data/raw/Three.xlsx")
Three$CalvingYear <- as.factor(Three$CalvingYear)

mod1 <- lm(Three$DFCFirstHeat~Three$AvgKeto20_atleast10 + Three$ad_Lactation + Three$PeakDFC + Three$AvgMY60 + Three$CalvingSeason)
summary(mod1)
plot(mod1)


# Log transformation
Three.log <- Three %>%
  mutate(log.DFC_CLA = log(DFC_CLA),
         log.DFCFirstHeat = log(DFCFirstHeat), 
         log.DaysToFirstIns = log(DaysToFirstIns), 
         log.AvgKeto20 = log(AvgKeto20_atleast10), 
         log.AvgKeto60 = log(AvgKeto60_atleast10)) #4327 obs of 71v
         

mod1.log <- lm(Three.log$log.DFCFirstHeat~Three.log$AvgKeto20_atleast20 + Three.log$ad_Lactation + Three.log$PeakDFC + Three.log$AvgMY60 + Three.log$CalvingSeason)
summary(mod1.log)
plot(mod1.log)

mod2.log <- lm(Three.log$log.DFCFirstHeat~Three.log$log.AvgKeto20 + Three.log$ad_Lactation + Three.log$PeakDFC + Three.log$AvgMY60 + Three.log$CalvingSeason)
mod2.log2 <- lm(log.DFCFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, data = Three.log)
summary(mod2.log)
summary(mod2.log2)
plot(mod2.log)

anova(mod1.log, mod2.log)
compare_performance(mod1.log, mod2.log, rank = TRUE)
```

# Generalized Linear Model
```{r}
glm.mod1 <- glm(DFCFirstHeat~AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, family = "gaussian", data = Three)

glm1.log <- glm(log.DFCFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, data = Three.log, family = "gaussian")
summary(glm1.log) # the same as linear model
glm1.log$aic

anova(glm.mod1, glm1.log, test = "Chisq")
```

# Survival regression
```{r}
df.surv1 <- survfit(Surv(rDFC, KetoCow)~ad_Lactation, data=Three)
summary(df.surv1)
plot(df.surv1, main="Cumulative Survival Function", lty=c(1, 2, 3, 4), xlab="Day after calving (day)", ylab="Probability")
legend(x=0, y=0.6)
```
```{r}
Three.surv <- Three %>%
  mutate(FirstHeat = ifelse(is.na(Three$DFCFirstHeat), 0, 1)) %>%
  mutate(FirstAI = ifelse(is.na(Three$DaysToFirstIns), 0, 1)) %>%
  mutate(KetoStatus20 = ifelse(Three$AvgKeto20_atleast10 >= 0.08, 1, 0))

## First Heat
df.cox1.heat <- coxph(Surv(DFCFirstHeat, FirstHeat) ~ AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.surv)
summary(df.cox1.heat)

ggsurvplot(survfit(df.cox1.heat), data = Three.surv, color= "#2E9FDF",
           ggtheme = theme_minimal())


## Frist AI
df.cox1 <- coxph(Surv(DaysToFirstIns, FirstAI) ~ AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.surv)
summary(df.cox1)

ggsurvplot(survfit(df.cox1), data = Three.surv, color= "#2E9FDF",
           ggtheme = theme_minimal())

```

# Poisson regression
```{r}
p.mod1 <- glm(Last_AI ~ AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), family = poisson(link = "log"), data = Three)

summary(p.mod1)

plot(p.mod1)
```
