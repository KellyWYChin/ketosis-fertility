---
title: "Model building"
author: "Kelly Chin"
date: "3/22/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# R libraries
```{r}
library(readxl)
library(dplyr)
library(performance)
library(survival)
library(survminer)
library(tidyr)
library(gtsummary)
library(coxme)
library(lme4)
library(nlme)
library(ggplot2)
```

# Data
```{r}
Three <- read_excel("../data/raw/Three.xlsx")
#Three$CalvingYear <- as.factor(ifelse(Three$CalvingYear == 2018, 1, 2))
```

# Linear Model
```{r}
mod1 <- lm(Three$DaysToFirstHeat~Three$AvgKeto20_atleast10 + Three$MaxKetoDIM20 + factor(Three$ad_Lactation) + Three$PeakDFC + Three$AvgMY20 + Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1)
plot(mod1)

mod1_AvgMY <- lm(Three$DaysToFirstHeat~Three$AvgKeto20_atleast10 + factor(Three$ad_Lactation) + Three$PeakDFC +Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1_AvgMY)

anova(mod1, mod1_AvgMY)

mod1.1 <- lm(Three$DaysToFirstHeat~Three$AvgKeto20_atleast10 + Three$Lactation + Three$PeakDFC + Three$AvgMY20 + Three$CalvingSeason + factor(Three$FarmNo))
summary(mod1.1)

anova(mod1, mod1.1)

# Times AvgKeto20_atleast10 to 100 for easier quantify the one unit change of ketosis value and the influence on fertiliy
Three <- Three %>%
  mutate(AvgKeto20_100 = 100*AvgKeto20_atleast10)

mod1.100 <- lm(DaysToFirstHeat~AvgKeto20_100 + MaxKetoDIM20 + factor(ad_Lactation) + PeakDFC + AvgMY20 + CalvingSeason + factor(FarmNo), data = Three)
summary(mod1.100)
    
```

# Log transformation (1)
```{r}
Three.log <- Three %>%
  mutate(log.DFC_CLA = log(DFC_CLA),
         log.DaysToFirstHeat = log(DaysToFirstHeat), 
         log.DaysToFirstIns = log(DaysToFirstIns), 
         log.AvgKeto20 = log(AvgKeto20_atleast10), 
         log.AvgKeto60 = log(AvgKeto60_atleast10)) #4327 obs of 71v

# log transform the outcome variable
mod1.log <- lm(log.DaysToFirstHeat~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo, data = Three.log)
summary(mod1.log)
#plot(mod1.log)

# FarmNo and interaction with ketosis
mod1.log.int <- lm(log.DaysToFirstHeat~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo:AvgKeto20_atleast10, data = Three.log)
summary(mod1.log.int)
#plot(mod1.log.int)

anova(mod1.log, mod1.log.int)
```

# Log transformation (2)
```{r}
# log transform both outcome and explantory variables
mod2.log <- lm(log.DaysToFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + FarmNo, data = Three.log)
summary(mod2.log)
plot(mod2.log)

# FarmNo and interaction with ketosis
mod2.log.int <- lm(log.DaysToFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo):log.AvgKeto20, data = Three.log)
summary(mod2.log.int)
plot(mod2.log.int)

compare_performance(mod2.log, mod2.log.int, rank = TRUE)


mod2.log1 <- lm(log.DaysToFirstHeat~log.AvgKeto20 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.log)
mod2.log2 <- lm(log.DaysToFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo), data = Three.log)
summary(mod2.log1)
summary(mod2.log2)

compare_performance(mod2.log1, mod2.log2, rank = TRUE)
```

# Generalized Linear Model
```{r}
glm.mod1 <- glm(DaysToFirstHeat~AvgKeto20_atleast10 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, family = "gaussian", data = Three)

glm.log1 <- glm(log.DaysToFirstHeat~log.AvgKeto20 + factor(ad_Lactation) + PeakDFC + AvgMY60 + CalvingSeason, data = Three.log, family = "gaussian")
summary(glm1.log) # the same as linear model
glm1.log$aic

anova(glm.mod1, glm.log1, test = "Chisq")
```

# Survival regression
```{r}
## Example
#df.surv1 <- survfit(Surv(rDFC, KetoCow)~ad_Lactation, data=Three)
#summary(df.surv1)
#plot(df.surv1, main="Cumulative Survival Function", lty=c(1, 2, 3, 4), xlab="Day after calving (day)", ylab="Probability")
#legend(x=0, y=0.6)
```
```{r}
survival <- Three %>%
  mutate(FirstCLA = ifelse(is.na(Three$DaysToCLA), 0, 1)) %>%
  mutate(FirstHeat = ifelse(is.na(Three$DaysToFirstHeat), 0, 1)) %>%
  mutate(FirstAI = ifelse(is.na(Three$DaysToFirstIns), 0, 1)) %>%
  mutate(KetoStatus20 = ifelse(Three$AvgKeto20_atleast10 >= 0.08, 1, 0)) %>%
  mutate(KetoQua = ifelse(Three$AvgKeto20_atleast10 >= 0.076, 4, 
                          ifelse(Three$AvgKeto20_atleast10 >= 0.061 & Three$AvgKeto20_atleast10 < 0.076, 3, 
                                 ifelse(Three$AvgKeto20_atleast10 >= 0.055 & Three$AvgKeto20_atleast10 < 0.061, 2, 
                                        ifelse(Three$AvgKeto20_atleast10 < 0.055, 1, NA))))) %>%
  mutate(KetoMaxDay = ifelse(Three$MaxKetoDIM20 >= 17, 4, 
                             ifelse(Three$MaxKetoDIM20 >= 12 & Three$MaxKetoDIM20 < 17, 3,
                                    ifelse(Three$MaxKetoDIM20 >= 8 & Three$MaxKetoDIM20 < 12, 2, 
                                           ifelse(Three$MaxKetoDIM20 <8, 1, NA))))) %>%
  mutate(KetoMaxDay2 = ifelse(Three$MaxKetoDIM20 >= 12, 1, 0)) %>%
  mutate(KetoMaxDay3 = ifelse(Three$MaxKetoDIM60 <= 14, "first2wk", 
                              ifelse(Three$MaxKetoDIM60 > 14 & Three$MaxKetoDIM60 <= 30, "firstmth",
                                     ifelse(Three$MaxKetoDIM60 > 30, "secondmth", NA))))

summary(survival)
survival$FarmNo <- as.factor(survival$FarmNo)
survival$CalvingSeason <- as.factor(survival$CalvingSeason)
survival$KetoStatus20 <- as.factor(survival$KetoStatus20)
survival$ad_Lactation <- as.factor(survival$ad_Lactation)
survival$KetoQua <- as.factor(survival$KetoQua)
```

# Descriptive statistics - DaysToCLA
```{r}
plot(survival$DaysToCLA, survival$AvgKeto20_100,
     xlab = "Time from calving to resupmtion of cyclicity", ylab = "Average milk BHB*100 (mmol/L)")
boxplot(survival$DaysToFirstHeat~survival$KetoStatus20, xlab = "Average milk BHB < 0.08: 0; >=0.08: 1", ylab = "Time from calving to first cyclicity")

plot(survival$DaysToCLA, survival$MaxKetoDIM60)

# DaysToCLA
ggplot(data=survival, aes(x=DaysToCLA))+
  geom_histogram(breaks=seq(0, 250, by=5),
                 fill="lightblue")+
  #facet_wrap(Three$FarmNo) +
  ggtitle("Time from Calving to Resumption of Cyclicity")+
  xlab("day")+
  ylab("#cows")+
  theme_classic()
summary(survival$DaysToCLA)
var(survival$DaysToCLA)
sd(survival$DaysToCLA)

# BOXPLOT- DaysToCLA vs. FarmNo
summary(survival$DaysToCLA)
sd(survival$DaysToCLA)
plot(survival$DaysToCLA ~ survival$AvgKeto20_100,
     xlab = "Average milk BHB*100 (mmol/L)", ylab = "Time from calving to resupmtion of cyclicity")

boxplot(survival$DaysToCLA ~ survival$FarmNo, xlab = "Farm ID", ylab = "Time from calving to resupmtion of cyclicity (day)")
ggplot(data = survival, aes(x = FarmNo, y = DaysToCLA)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Days from calving to resupmtion of cyclicity (day)") +
  theme(axis.text.x = element_text(angle = 90))
  
# BOXPLOT- AvgKeto20_100 vs. FarmNo
boxplot(survival$AvgKeto20_100 ~ survival$FarmNo)
ggplot(data = survival, aes(x = FarmNo, y = AvgKeto20_100)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Average milk BHB*100 (mmol/L)") +
  theme(axis.text.x = element_text(angle = 90))


boxplot(survival$DaysToCLA ~ survival$ad_Lactation, ylab = "Days from calving to resupmtion of cyclicity", xlab = "Parity")
#ggplot(data = survival, aes(x = ad_Lactation, y = DaysToCLA)) +
#  geom_boxplot(outlier.color = "red") + 
#  theme_classic() +
#  labs(x = "Parity", y = "Days from calving to first cyclicity")
```

## Survival curves (DaysToCLA)
```{r}
surv.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ 1, data = survival)
plot(surv.heat, main = "Cumulatvie survival time from calving to resumption of cyclicity",
     ylab = "Cumulative survival probability",
     xlab = "Time (days from calving to resumption of cyclicity)")
print(surv.cla)
ggsurvplot(surv.cla, data = survival,
           surv.median.line = "hv",
           xlab = "Time (days from calving to resumption of cyclicity",
           legend.title = "Cumulative survival time to resumption of cyclicity",
           pval = TRUE,
           conf.int = TRUE,
           risk.table = TRUE,
           tables.height = 0.2,
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv1.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ ad_Lactation, data=survival)
print(surv1.cla)
ggsurvplot(surv1.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to resumption of cyclicity",
           legend.title = "Parity", 
           legend.labs = c("1", "2", "3", "4+"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv2.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ KetoStatus20, data=survival)
summary(surv2.cla)
print(surv2.cla) #risk table
ggsurvplot(surv2.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to resumption of cyclicity",
           legend.title = "Ketosis status within 20 DIM", 
           legend.labs = c("Avg. BHB < 0.08", "Avg. BHB ≥ 0.08"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv3.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ KetoQua, data=survival)
print(surv3.cla)
ggsurvplot(surv3.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to  resumption of cyclicity",
           legend.title = "Avg. BHB within 20 DFC (mmol/L)", 
           legend.labs = c("<0.055", "0.055-0.061", "0.061-0.076", "≥0.076"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv4.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ KetoMaxDay, data=survival)
print(surv4.cla)
ggsurvplot(surv4.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to  resumption of cyclicity",
           legend.title = "Day when BHB reached maximum within 20 DIM", 
           legend.labs = c("< 8 days", "8-12", "12-17", "17-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv5.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ KetoMaxDay2, data=survival)
print(surv5.cla)
ggsurvplot(surv5.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to  resumption of cyclicity",
           legend.title = "Day when BHB reached maximum within 20 DIM", 
           legend.labs = c("<12", "12-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv6.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ CalvingYear, data = survival)
print(surv6.cla)
ggsurvplot(surv6.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to  resumption of cyclicity",
           legend.title = "Calving Year", 
           legend.labs = c("2018", "2019"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv7.cla <- survfit(Surv(DaysToCLA, FirstCLA) ~ CalvingSeason, data = survival)
print(surv7.cla)
ggsurvplot(surv7.cla, data=survival,
           surv.median.line = "hv",
           xlab = "Days from calving to  resumption of cyclicity",
           legend.title = "Calving Seasons", 
           legend.labs = c("Fall", "Spring", "Summer", "Winter"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())
```

# Cox proportional hazard regression - CLA vs Ketosis
```{r} 
# Univariate Cox regression
cox.ketostatus <- coxph(Surv(DaysToCLA, FirstCLA)~ factor(KetoStatus20), data = survival)
cox.ketostatus

cox.avgketo <- coxph(Surv(DaysToCLA, FirstCLA)~ AvgKeto20_100, data = survival)
cox.avgketo
plot(survfit(cox.avgketo, conf.int = TRUE, data = survival))

cox.maxketo20 <- coxph(Surv(DaysToCLA, FirstCLA)~ MaxKeto20, data = survival)
cox.maxketo20

cox.MaxKetoDIM20 <- coxph(Surv(DaysToCLA, FirstCLA)~ MaxKetoDIM20, data = survival)
cox.MaxKetoDIM20

cox.MaxKetoDIM60 <- coxph(Surv(DaysToCLA, FirstCLA)~ MaxKetoDIM60, data = survival)
cox.MaxKetoDIM60

cox.nhighketo20 <- coxph(Surv(DaysToCLA, FirstCLA)~ nHighKeto20, data = survival)
cox.nhighketo20

cox.ketodur20 <- coxph(Surv(DaysToCLA, FirstCLA)~ KetoDur20, data = survival)
cox.ketodur20
```

# Cox proportional hazard regression - CLA vs Farm Info
```{r}
# Univariate Cox regression
cox.lactation <- coxph(Surv(DaysToCLA, FirstCLA)~ ad_Lactation, data = survival)
cox.lactation

cox.lactation1 <- coxph(Surv(DaysToCLA, FirstCLA)~ Lactation, data = survival)
cox.lactation1

cox.farmno <- coxph(Surv(DaysToCLA, FirstCLA)~ FarmNo, data = survival)
cox.farmno

cox.calvingseason <- coxph(Surv(DaysToCLA, FirstCLA)~ CalvingSeason, data = survival)
cox.calvingseason

cox.peakdfc <- coxph(Surv(DaysToCLA, FirstCLA)~ PeakDFC, data = survival)
cox.peakdfc

cox.peakmy <- coxph(Surv(DaysToCLA, FirstCLA)~ PeakMY, data = survival)
cox.peakmy

cox.avgmy60 <- coxph(Surv(DaysToCLA, FirstCLA)~ AvgMY60, data = survival)
cox.avgmy60

cox.summy60 <- coxph(Surv(DaysToCLA, FirstCLA)~ SumMY60, data = survival)
cox.summy60

```

# Coxme model with random effect
```{r}
coxme.cla0 <- coxme(Surv(DaysToCLA, FirstCLA)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data = survival)
coxme.cla0

coxme.cla1 <- coxme(Surv(DaysToCLA, FirstCLA)~factor(KetoStatus20) + MaxKetoDIM60 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data = survival)
coxme.cla1

anova(coxme.cla0, coxme.cla1)

# Remove AvgMY60
coxme.cla0.1 <- coxme(Surv(DaysToCLA, FirstCLA)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data = survival)
coxme.cla0.1

anova(coxme.cla0, coxme.cla0.1) # loglik is the same, model coxme.cla0.1 is simpler

coxme.cla1.1 <- coxme(Surv(DaysToCLA, FirstCLA)~factor(KetoStatus20) + MaxKetoDIM60 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data = survival)
coxme.cla1.1

anova(coxme.cla0.1, coxme.cla1.1) # model coxme.cla0.1 is better

# Remove MaxKetoDIM60
coxme.cla0.2 <- coxme(Surv(DaysToCLA, FirstCLA)~AvgKeto20_100 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data = survival)
coxme.cla0.2

anova(coxme.cla0.1, coxme.cla0.2) # similar loglik, model coxme.cla0.2 is simpler

coxme.cla1.2 <- coxme(Surv(DaysToCLA, FirstCLA)~factor(KetoStatus20) + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data = survival)
coxme.cla1.2

# Remove farm size
coxme.cla0.3 <- coxme(Surv(DaysToCLA, FirstCLA)~AvgKeto20_100 + ad_Lactation + PeakDFC + CalvingSeason + (1|FarmNo), data = survival)
coxme.cla0.3

anova(coxme.cla0.2, coxme.cla0.3) # model coxme.cla0.2 has higher loglik

AIC(coxme.cla0.2) # 58791.65
AIC(coxme.cla0.3) # 58793.48

coxme.cla1.3 <- coxme(Surv(DaysToCLA, FirstCLA)~factor(KetoStatus20) + ad_Lactation + PeakDFC + CalvingSeason + (1|FarmNo), data = survival)

anova(coxme.cla1.2, coxme.cla1.3) # model coxme.cla1.2 has higher loglik

AIC(coxme.cla1.2) # 58800.21
AIC(coxme.cla1.3) # 58801.9

########################
##     FINAL MODEL    ##
########################




```

# Descriptive statistics - DaysToFirstHeat
```{r}
plot(survival$DaysToFirstHeat, survival$AvgKeto20_100,
     xlab = "Time from calving to first heat", ylab = "Average milk BHB*100 (mmol/L)")
boxplot(survival$DaysToFirstHeat~survival$KetoStatus20, xlab = "Average milk BHB < 0.08 = 0, >=0.08 = 1",
        ylab = "Time from calving to first heat")

plot(survival$DaysToFirstHeat, survival$MaxKetoDIM60)

# DaysToFirstHeat
ggplot(data=survival, aes(x=DaysToFirstHeat))+
  geom_histogram(breaks=seq(0, 250, by=5),
                 fill="lightblue")+
  #facet_wrap(Three$FarmNo) +
  ggtitle("Time from Calving to First Heat")+
  xlab("day")+
  ylab("#cows")+
  theme_classic()
summary(survival$DaysToFirstHeat)
var(survival$DaysToFirstHeat)
sd(survival$DaysToFirstHeat)

# BOXPLOT- DaysToFirstHeat vs. FarmNo
summary(survival$DaysToFirstHeat)
sd(survival$DaysToFirstHeat)
plot(survival$DaysToFirstHeat ~ survival$AvgKeto20_100,
     xlab = "Average milk BHB*100 (mmol/L)", ylab = "Time from calving to first recognized heat")
boxplot(survival$DaysToFirstHeat ~ survival$FarmNo, xlab = "Farm ID", ylab = "Time from calving to first recognized heat")
ggplot(data = survival, aes(x = FarmNo, y = DaysToFirstHeat)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Days from calving to first recognized heat") +
  theme(axis.text.x = element_text(angle = 90))
  
# BOXPLOT- AvgKeto20_100 vs. FarmNo
boxplot(survival$AvgKeto20_100 ~ survival$FarmNo)
ggplot(data = survival, aes(x = FarmNo, y = AvgKeto20_100)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Average milk BHB*100 (mmol/L)") +
  theme(axis.text.x = element_text(angle = 90))


boxplot(survival$DaysToFirstHeat ~ survival$ad_Lactation, 
        xlab = "Parity", ylab = "Days from calving to first recognized heat")
ggplot(data = survival, aes(x = ad_Lactation, y = DaysToFirstHeat)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Parity", y = "Days from calving to first recognized heat")
```

## Survival curves (DaysToFirstHeat)
```{r}
surv.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ 1, data = survival)
plot(surv.heat, main = "Cumulatvie survival time from calving to first heat",
     ylab = "Cumulative survival probability",
     xlab = "Time (days from calving to first heat)")
print(surv.heat)
ggsurvplot(surv.heat, data = survival,
           surv.median.line = "hv",
           xlab = "Time (days from calving to first heat",
           legend.title = "Cumulative survival time to first heat",
           pval = TRUE,
           conf.int = TRUE,
           risk.table = TRUE,
           tables.height = 0.2,
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv1.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ ad_Lactation, data=survival)
print(surv1.heat)
ggsurvplot(surv1.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Parity", 
           legend.labs = c("1", "2", "3", "4+"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

# Change font size, style and color
#++++++++++++++++++++++++++++++++++++
if (FALSE) {
# Change font size, style and color at the same time
ggsurvplot(surv1.heat, data = survival,  main = "Survival curve",
   font.main = c(16, "bold", "darkblue"),
   font.x = c(14, "bold.italic", "red"),
   font.y = c(14, "bold.italic", "darkred"),
   font.tickslab = c(12, "plain", "darkgreen"))
}

surv2.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoStatus20, data=survival)
summary(surv2.heat)
print(surv2.heat) #risk table
ggsurvplot(surv2.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Ketosis status within 20 DFC", 
           legend.labs = c("Avg. BHB < 0.08", "Avg. BHB ≥ 0.08"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv3.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoQua, data=survival)
print(surv3.heat)
ggsurvplot(surv3.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Avg. BHB within 20 DFC (mmol/L)", 
           legend.labs = c("<0.055", "0.055-0.061", "0.061-0.076", "≥0.076"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv4.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoMaxDay, data=survival)
print(surv4.heat)
ggsurvplot(surv4.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Day when BHB reached maximum within 20 DFC (DFC)", 
           legend.labs = c("< 8 days", "8-12", "12-17", "17-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv5.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ KetoMaxDay2, data=survival)
print(surv5.heat)
ggsurvplot(surv5.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Day when BHB reached maximum within 20 DFC (DFC)", 
           legend.labs = c("<12", "12-20"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv6.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ CalvingYear, data = survival)
print(surv6.heat)
ggsurvplot(surv6.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Calving Year", 
           legend.labs = c("2018", "2019"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv7.heat <- survfit(Surv(DaysToFirstHeat, FirstHeat) ~ CalvingSeason, data = survival)
print(surv7.heat)
ggsurvplot(surv7.heat, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First Heat",
           legend.title = "Calving Seasons", 
           legend.labs = c("Fall", "Spring", "Summer", "Winter"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())
```

## Cox proportional hazard regression - First Heat vs ketosis
```{r} 
# Univariate Cox regression
cox.ketostatus <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ KetoStatus20, data = survival)
cox.ketostatus
plot(survfit(cox.avgketo, conf.int = TRUE, data = survival))

cox.avgketo <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100, data = survival)
cox.avgketo

cox.maxketo20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ MaxKeto20, data = survival)
cox.maxketo20

cox.MaxKetoDIM20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ MaxKetoDIM20, data = survival)
cox.MaxKetoDIM20

cox.MaxKetoDIM60 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ MaxKetoDIM60, data = survival)
cox.MaxKetoDIM60

cox.nhighketo20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ nHighKeto20, data = survival)
cox.nhighketo20

cox.ketodur20 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ KetoDur20, data = survival)
cox.ketodur20
```

## Cox proportional hazard regression - First Heat vs Farm Info
```{r}
# Univariate Cox regression
cox.lactation <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ ad_Lactation, data = survival)
cox.lactation

cox.lactation1 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ Lactation, data = survival)
cox.lactation1

cox.farmno <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ FarmNo, data = survival)
cox.farmno

cox.calvingseason <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ CalvingSeason, data = survival)
cox.calvingseason

cox.peakdfc <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ PeakDFC, data = survival)
cox.peakdfc

cox.peakmy <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ PeakMY, data = survival)
cox.peakmy

cox.avgmy60 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgMY60, data = survival)
cox.avgmy60

cox.summy60 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ SumMY60, data = survival)
cox.summy60
```

## Multiple covariates at once
```{r}
# Multiple covariates at once for univariate coxph
covariates <- c("AvgKeto20_atleast10", "MaxKetoDIM20", #"nHighKeto20", "KetoDur20",
                #"KetoStatus20", "KetoQua", "KetoMaxDay", "KetoMaxDay2", 
                #"PeakDFC", 
                "AvgMY20", "SumMY20",
                "ad_Lactation", "CalvingYear", "CalvingSeason", 
                "FarmNo", "Lactation")

univ_formulas <- sapply(covariates,
                        function(x) as.formula(paste('Surv(DaysToFirstHeat, FirstHeat) ~', x)), 
                        simplify = FALSE)

univ_formulas <- vector()
for (x in covariates) {
  univ_formulas <- c(univ_formulas, paste('Surv(DaysToFirstHeat, FirstHeat) ~', x))
}

univ_models <- lapply(univ_formulas, function(x)(coxph(as.formula(x), data = survival)))

coxph(as.formula(univ_formulas[5]), data = survival)
univ_models

summary(survival)
## Extract data
univ_results <- lapply(univ_models, 
                       function(x){
                         x <- summary(x)
                         p.value <- signif(x$wald["pvalue"], digits = 2)
                         wald.test <- signif(x$wald["test"], digits = 2)
                         beta <- signif(x$coef[1], digits = 2); #coefficient beta
                         HR <- signif(x$coef[2], digits = 2);
                         HR.confint.lower <- signif(x$conf.int[,"lower .95"], 2)
                         HR.confint.upper <- signif(x$conf.int[,"upper .95"], 2)
                         HR <- paste0(HR, " (",
                                      HR.confint.lower, "-", HR.confint.upper, ")")
                         res <- c(beta, HR, wald.test, p.value)
                         names(res) <- c("beta", "HR (95% CI for HR)", 
                                         "wald.test", "p.value")
                         return(res)
                         #return(exp(cbind(coef(x), confint(x))))
                       })
x <- univ_models[[3]]
summary(x)
p.value <- signif(summary(x)$wald[3], digits = 5)
str(summary(x))

res <- t(as.data.frame(univ_results, check.names = FALSE))

```

## Cox PH model with different milk parameters
```{r}
cox0 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~1, data=survival)
cox10 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100, data = survival)

cox1 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox1

cox2 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakMY + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox2
anova(cox1, cox2)

drop1(cox2) # model 2 without dropping any parameter is the best
MASS::stepAIC(cox2) 

plot(survival$PeakMY, survival$AvgMY60)
cor(survival$PeakMY, survival$AvgMY60) # 0.9, highly correlated variables
# CAN ONLY CHOOSE ONE VARIABLE

cor(survival$AvgKeto20_100, survival$MaxKetoDIM60) # -0.169

# change AvgMY60 to PeakDFC
cox3 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakMY + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox3
drop1(cox3) # model 3 without dropping any parameter is the best
plot(survival$PeakMY, survival$PeakDFC)
cor(survival$PeakDFC, survival$PeakMY) # not highly correlated

anova(cox2, cox3) # model 2 is better than model 3, but model 2 has multicollinearity problem

# only use one milk variable (PeakMY)
cox4 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakMY + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox4

anova(cox2, cox4) # model 2 is better than model 4
anova(cox3, cox4) # model 3 is slightly better than model 4

# only use AvgMY60
cox5 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox5 # AvgMY60 is not significant in the model, can be removed

# put MaxKetoDIM60 into the model
cox6 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox6

# remove AvgMY60
cox7 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox7

# add PeakMY
cox8 <- coxph(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakMY + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)), data=survival)
cox8
```

## Coxme model with random effect
```{r}
coxme0 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme0

coxme1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme1
anova(coxme0, coxme1)

AIC(coxme0) # 58811.97
AIC(coxme1) # 58802.4 coxme1 is better 

coxme2 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme2
anova(coxme1, coxme2)
# coxme2 is almost the same as coxme1
AIC(coxme2) # 58800.51 

coxme3 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme3
anova(coxme2, coxme3) # no better than coxme2
AIC(coxme3) # 58811.97

coxme4 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme4
anova(coxme3, coxme4) # coxme3 and coxme4 are the same, coxme4 is simpler 

coxme5 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + I(PeakDFC/7) + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme5
anova(coxme4, coxme5) # coxme4 and coxme5 are the same, coxme5

coxme6 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + I(PeakDFC/7) + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme6
anova(coxme2, coxme6) # coxme2 is the same as coxme6
AIC(coxme6) # 58800.51

# remove farm size
coxme7 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + factor(ad_Lactation) + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
coxme7
AIC(coxme7) # 58801.19 coxme7 is simpler than coxme6, AIC difference no more than 2 points

# lactation as a continuous variable
coxme7.1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + Lactation + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
coxme7.1

AIC(coxme7.1) # 58801.09

# model 7 without peakDFC
coxme8 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + factor(ad_Lactation) + CalvingSeason + (1|FarmNo), data=survival)
coxme8

AIC(coxme8) # 58804.73
AIC(coxme8) - AIC(coxme7) # 3.5 -> model 7 is better

# model 7 without calving season
coxme9 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + factor(ad_Lactation) + I(PeakDFC/7) + (1|FarmNo), data=survival)
AIC(coxme9) # 58814.04. AIC increases a lot, model 7 is better


coxme1$loglik
coxme2$loglik
coxme6$loglik
AIC(coxme1)
AIC(coxme2)
AIC(coxme6)

#########################
##  Check Interaction  ##
#########################
coxme3 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + AvgKeto20_100:ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme3
anova(coxme2, coxme3)
# don't need to consider interaction between ketosis and parity

coxme4 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + ad_Lactation + AvgKeto20_100:PeakDFC + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme4
anova(coxme2, coxme4)
# don't need to consider interaction between ketosis and peak day of highest milk 

####################################
##  Categorical ketosis variable  ##
####################################
keto1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~factor(KetoStatus20) + KetoMaxDay3 + ad_Lactation + I(PeakDFC/7) + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
keto1
anova(keto1, coxme6) # coxme6 is slightly better 

keto1.1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~factor(KetoStatus20) + MaxKetoDIM60 + ad_Lactation + I(PeakDFC/7) + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
keto1.1
anova(keto1.1, coxme6) # coxme6 is slightly better
anova(keto1, keto1.1) # keto1.1 = keto1

# use quantile 
keto2 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~factor(KetoQua) + KetoMaxDay3 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
keto2
anova(keto1, keto2) # keto1 = keto2
anova(keto1.1, keto2) # keto1.1 = keto2

###########################
##      FINAL MODEL      ##
###########################
coxme7 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + factor(ad_Lactation) + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
coxme7
AIC(coxme7) # 58801.19 coxme7 is simpler than coxme6, AIC difference no more than 2 points

AIC(keto1) # 58813.51
AIC(keto1.1) # 58809.45

```

## model check
```{r}
resid.cox10 <- resid(cox10, type = "martingale")
resid.cox0 <- resid(cox0, type = "martingale")
#par(mfrow = c(1,2))
plot(survival$AvgKeto20_100, resid.cox0)
lines(lowess(survival$AvgKeto20_100, resid.cox0))
plot(log(survival$AvgKeto20_100), resid.cox0)
lines(lowess(log(survival$AvgKeto20_100), resid.cox0))

plot(survival$AvgKeto20_100, resid.cox10)
lines(lowess(survival$AvgKeto20_100, resid.cox10))
plot(log(survival$AvgKeto20_100), resid.cox10)
lines(lowess(log(survival$AvgKeto20_100), resid.cox10))
```

### Martingale residuals: check linearity
```{r}
##########################
##      FINAL MODEL     ##
##########################
# check AvgKeto20_100 in coxme7
coxme7 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + factor(ad_Lactation) + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
coxme7

me7.keto1 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ MaxKetoDIM60 + factor(ad_Lactation) + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
res.keto1 <- resid(me7.keto1, type = "martingale")
plot(survival$AvgKeto20_100, res.keto1, main = "Residual of AvgKeto20_100")
lines(lowess(survival$AvgKeto20_100, res.keto1), col = "red")

# check MaxKetoDIM60 in coxme7
me7.keto2 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + factor(ad_Lactation) + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
res.keto2 <- resid(me7.keto2, type = "martingale")
plot(survival$MaxKetoDIM60, res.keto2, main = "Residual of MaxKetoDIM60")
lines(lowess(survival$MaxKetoDIM60, res.keto2), col = "red")

# check PeakDFC in coxme7
me7.lact <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + factor(ad_Lactation) + CalvingSeason + (1|FarmNo), data=survival)
res.lact <- resid(me7.lact, type = "martingale")
plot(survival$PeakDFC, res.lact, main = "Residual of PeakDFC")
lines(lowess(survival$PeakDFC, res.lact), col = "red")
```

```{r}
# check AvgKeto20_100 in coxme2
coxme2.keto <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ MaxKetoDIM60 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2 <- resid(coxme2.keto, type = "martingale")
plot(survival$AvgKeto20_100, res.coxme2, main = "Residual of AvgKeto20_100")
lines(lowess(survival$AvgKeto20_100, res.coxme2), col = "red")

# check MaxKetoDIM60 in coxme2
coxme2.ketodfc <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + ad_Lactation + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2.ketodfc60 <- resid(coxme2.ketodfc, type = "martingale")
plot(survival$MaxKetoDIM60, res.coxme2.ketodfc60, main = "Residual of MaxKetoDIM60")
lines(lowess(survival$MaxKetoDIM60, res.coxme2.ketodfc60), col = "red")

# check PeakDFC in coxme2
coxme2.peakdfc <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2.peakdfc <- resid(coxme2.peakdfc, type = "martingale")
plot(survival$PeakDFC, res.coxme2.peakdfc, main = "Residual of PeakDFC")
lines(lowess(survival$PeakDFC, res.coxme2.peakdfc), col = "red")
```

```{r}
coxme2.lact <- coxme(Surv(DaysToFirstHeat, FirstHeat)~ AvgKeto20_100 + PeakDFC + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
res.coxme2.lact <- resid(coxme2.lact, type = "martingale")
plot(survival$ad_Lactation, res.coxme2.lact, main = "Residual of ad_Lactation")
lines(lowess(survival$ad_Lactation, res.coxme2.lact), col = "red")
```

# Df Beta residuals
```{r}
resid.coxme1 <- resid(coxme1, type = "dfbeta")
plot(survival$AvgKeto20_100, resid.coxme1[,1], ylab = "dfbeta for AvgKeto20_100")
plot(survival$ad_Lactation, resid.coxme1[,2], ylab="dfbeta for ad_Lactation")
resid.coxme1[,1]
```

```{r}
##########################
##      FINAL MODEL     ##
##########################
# check AvgKeto20_100 in coxme7
coxme7 <- coxme(Surv(DaysToFirstHeat, FirstHeat)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + I(PeakDFC/7) + CalvingSeason + (1|FarmNo), data=survival)
#coxme7

#print(coxme.fit7.I <- cox.zph(coxme7, transform = "identity"))
print(coxme.fit7.KM <- cox.zph(coxme7, transform = "km"))
#print(coxme.fit7.L <- cox.zph(coxme7, transform = "log"))
par(mfrow = c(1,3))
#plot(coxme.fit7.I)
plot(coxme.fit7.KM)
#plot(coxme.fit7.L)
```

```{r}
## First Heat
df.cox1.heat <- coxph(Surv(DaysToFirstHeat, FirstHeat) ~ ad_Lactation + AvgKeto20_atleast10 + MaxKetoDIM20 + PeakDFC + AvgMY20 + CalvingSeason  + factor(FarmNo), data = survival)
summary(df.cox1.heat)

ggsurvplot(survfit(df.cox1.heat), data = survival, color= "#2E9FDF", ggtheme = theme_minimal())

ggsurv <- ggsurvplot(survfit(df.cox1.heat), data = survival, 
                     fun = "cumhaz", conf.int = TRUE, 
                     risk.table = TRUE, risk.table.col = "strata", 
                     ggtheme = theme_bw())
curv_facet <- ggsurv$plot + facet_grid(AvgKeto20_atleast10 ~ PeakDFC + AvgMY60 + CalvingSeason + factor(FarmNo))
curv_facet
```

# Descriptive statistics - DaysToFirstIns
```{r}
plot(survival$DaysToFirstIns, survival$AvgKeto20_100,
     xlab = "Time from calving to first AI", ylab = "Average milk BHB*100 (mmol/L)")

boxplot(survival$DaysToFirstIns~survival$KetoStatus20, xlab = "Average milk BHB < 0.08 = 0, >=0.08 = 1",
        ylab = "Time from calving to first AI")

plot(survival$DaysToFirstIns, survival$MaxKetoDIM60)

# DaysToFirstIns
ggplot(data=survival, aes(x=DaysToFirstIns))+
  geom_histogram(breaks=seq(0,300, by=5),
                 fill="lightblue")+
  #facet_wrap(Three$FarmNo) +
  ggtitle("Time from Calving to First AI")+
  xlab("day")+
  ylab("#cows")+
  theme_classic()
summary(survival$DaysToFirstIns)
var(survival$DaysToFirstIns, na.rm=TRUE)
sd(survival$DaysToFirstIns, na.rm=TRUE)

# BOXPLOT- DaysToFirstIns vs. FarmNo
summary(survival$DaysToFirstIns)
sd(survival$DaysToFirstIns, na.rm = TRUE)
plot(survival$DaysToFirstIns ~ survival$AvgKeto20_100)
boxplot(survival$DaysToFirstIns ~ survival$FarmNo, xlab = "Farm ID", ylab = "Time from calving to first AI")
ggplot(data = survival, aes(x = FarmNo, y = DaysToFirstIns)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Days from calving to first AI (day)") +
  theme(axis.text.x = element_text(angle = 90))
  
# BOXPLOT- AvgKeto20_100 vs. FarmNo
boxplot(survival$AvgKeto20_100 ~ survival$FarmNo)
ggplot(data = survival, aes(x = FarmNo, y = AvgKeto20_100)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Farm ID", y = "Average milk BHB*100 (mmol/L)") +
  theme(axis.text.x = element_text(angle = 90))

boxplot(survival$DaysToFirstIns ~ survival$ad_Lactation)
ggplot(data = survival, aes(x = ad_Lactation, y = DaysToFirstIns)) +
  geom_boxplot(outlier.color = "red") + 
  theme_classic() +
  labs(x = "Parity", y = "Days from calving to first AI (day)")
```

## Survival curves (DaysToFirstIns)
```{r}
surv.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ 1, data = survival)
plot(surv.ai, main = "Cumulatvie survival time from calving to first AI",
     ylab = "Cumulative survival probability",
     xlab = "Time (days from calving to first AI)")
print(surv.ai)
ggsurvplot(surv.ai, data = survival,
           surv.median.line = "hv",
           xlab = "Time (days from calving to first AI)",
           legend.title = "Cumulative survival time to first AI",
           pval = TRUE,
           conf.int = TRUE,
           risk.table = TRUE,
           tables.height = 0.2,
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv1.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ ad_Lactation, data=survival)
print(surv1.ai)
ggsurvplot(surv1.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Parity", 
           legend.labs = c("1", "2", "3", "4+"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv2.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ KetoStatus20, data=survival)
summary(surv2.ai)
print(surv2.ai) #risk table
ggsurvplot(surv2.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Ketosis status within 20 DIM", 
           legend.labs = c("Avg. BHB < 0.08", "Avg. BHB ≥ 0.08"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv3.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ KetoQua, data=survival)
print(surv3.ai)
ggsurvplot(surv3.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Avg. BHB within 20 DIM (mmol/L)", 
           legend.labs = c("<0.055", "0.055-0.061", "0.061-0.076", "≥0.076"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv4.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ KetoMaxDay, data=survival)
print(surv4.ai)
ggsurvplot(surv4.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Day when BHB reached maximum within 20 DIM", 
           legend.labs = c("< 8 d", "8-12 d", "12-17 d", "17-20 d"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv5.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ KetoMaxDay2, data=survival)
print(surv5.ai)
ggsurvplot(surv5.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Day when BHB reached maximum within 20 DIM", 
           legend.labs = c("<12 d", "12-20 d"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv6.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ CalvingYear, data = survival)
print(surv6.ai)
ggsurvplot(surv6.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Calving Year", 
           legend.labs = c("2018", "2019"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.2, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())

surv7.ai <- survfit(Surv(DaysToFirstIns, FirstAI) ~ CalvingSeason, data = survival)
print(surv7.ai)
ggsurvplot(surv7.ai, data=survival,
           surv.median.line = "hv",
           xlab = "Days from Calving to First AI",
           legend.title = "Calving Seasons", 
           legend.labs = c("Fall", "Spring", "Summer", "Winter"),
           pval = TRUE, 
           conf.int = TRUE, 
           risk.table = TRUE,
           tables.height = 0.28, 
           tables.theme = theme_cleantable(),
           ggtheme = theme_bw())
```

## Cox hazard proportional regression - First AI vs ketosis
```{r} 
# Univariate Cox regression
cox.ketostatus <- coxph(Surv(DaysToFirstIns, FirstAI)~ KetoStatus20, data = survival)
cox.ketostatus
plot(survfit(cox.ketostatus, conf.int = TRUE, data = survival))

cox.avgketo <- coxph(Surv(DaysToFirstIns, FirstAI)~ AvgKeto20_100, data = survival)
cox.avgketo

cox.maxketo20 <- coxph(Surv(DaysToFirstIns, FirstAI)~ MaxKeto20, data = survival)
cox.maxketo20

cox.MaxKetoDIM20 <- coxph(Surv(DaysToFirstIns, FirstAI)~ MaxKetoDIM20, data = survival)
cox.MaxKetoDIM20

cox.MaxKetoDIM60 <- coxph(Surv(DaysToFirstIns, FirstAI)~ MaxKetoDIM60, data = survival)
cox.MaxKetoDIM60

cox.nhighketo20 <- coxph(Surv(DaysToFirstIns, FirstAI)~ nHighKeto20, data = survival)
cox.nhighketo20

cox.ketodur20 <- coxph(Surv(DaysToFirstIns, FirstAI)~ KetoDur20, data = survival)
cox.ketodur20
```

## Cox hazard proportional regression - First AI vs Farm Info
```{r}
# Univariate Cox regression
cox.lactation <- coxph(Surv(DaysToFirstIns, FirstAI)~ ad_Lactation, data = survival)
cox.lactation

cox.lactation1 <- coxph(Surv(DaysToFirstIns, FirstAI)~ Lactation, data = survival)
cox.lactation1

cox.farmno <- coxph(Surv(DaysToFirstIns, FirstAI)~ FarmNo, data = survival)
cox.farmno

cox.calvingseason <- coxph(Surv(DaysToFirstIns, FirstAI)~ CalvingSeason, data = survival)
cox.calvingseason # NOT SIGNIFICANT

cox.peakdfc <- coxph(Surv(DaysToFirstIns, FirstAI)~ PeakDFC, data = survival)
cox.peakdfc # NOT SIGNIFICANT

cox.peakmy <- coxph(Surv(DaysToFirstIns, FirstAI)~ PeakMY, data = survival)
cox.peakmy

cox.avgmy60 <- coxph(Surv(DaysToFirstIns, FirstAI)~ AvgMY60, data = survival)
cox.avgmy60

cox.summy60 <- coxph(Surv(DaysToFirstIns, FirstAI)~ SumMY60, data = survival)
cox.summy60
```

## Coxme model with random effect
```{r}
coxme0 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + (1|FarmNo), data=survival)
coxme0
coxme1 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme1

AIC(coxme1) # 56686.7

# lactation as continuous variable 
coxme2 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + MaxKetoDIM60 + Lactation + PeakDFC + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme2
anova(coxme1, coxme2) #almost the same

AIC(coxme2) # 56683.34, COXME2 is better

# remove CalvingSeason
coxme3 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + PeakDFC + AvgMY60 + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme3
anova(coxme2, coxme3) #almost the same

AIC(coxme3) # 56683.32

# remove MaxKetoDIM60
coxme4 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + ad_Lactation + PeakDFC + AvgMY60 + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme4
anova(coxme3, coxme4) # coxme3 and coxme4 are the same, coxme4 is simpler 
AIC(coxme4) # 56682.94, coxme4 is simpler

# remove ad_Lactation
coxme5 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + PeakDFC + AvgMY60 + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme5
anova(coxme4, coxme5) # coxme4 and coxme5 are almost the same, coxme5 is simpler
AIC(coxme5) # 56681.51, coxme5 is better

# remove CowNo
coxme6 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + PeakDFC + AvgMY60 + (1|FarmNo), data=survival)
coxme6
anova(coxme5, coxme6) # coxme5 and coxme6 are almost the same, coxme6 is simpler
AIC(coxme6) # 56673.49, coxme6 is better

#########################
##  Check Interaction  ##
#########################
coxme7 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + ad_Lactation + AvgKeto20_100:ad_Lactation + PeakDFC + AvgMY60 + (1|FarmNo), data=survival)
coxme7
# don't need to consider interaction between ketosis and parity

coxme8 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + ad_Lactation + PeakDFC:ad_Lactation + PeakDFC + AvgMY60 + (1|FarmNo), data=survival)
coxme8
anova(coxme6, coxme8) #coxme6 and coxme8 are almost the same
# there is an interaction between PeakDFC and Parity

coxme9 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + ad_Lactation + AvgMY60:ad_Lactation + PeakDFC + AvgMY60 + (1|FarmNo), data=survival)
coxme9
anova(coxme8, coxme9)
# don't need to consider interaction between average milk yield and lactation

coxme10 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + AvgMY60:KetoStatus20 + PeakDFC + AvgMY60 + (1|FarmNo), data=survival)
coxme10
anova(coxme8, coxme10)
# don't need to consider interaction between milk yield and average ketosis

######################################
##  Don't put PeakDFC in the model  ##
######################################
coxme1 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + AvgMY60 + CalvingSeason + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme1
# parity becomes significant

# remove CalvingSeason
coxme2 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + AvgMY60 + cut(CowNo, c(0, 100, 180, 1000)) + (1|FarmNo), data=survival)
coxme2 
# parity becomes NOT significant

# remove CowNo
coxme3 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + MaxKetoDIM60 + ad_Lactation + AvgMY60 + (1|FarmNo), data=survival)
coxme3
# parity, maxketodim60 are NOT significant

# remove MaxKetoDIM60
coxme4 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + ad_Lactation + AvgMY60 + (1|FarmNo), data=survival)
coxme4
# parity is NOT significant

# remove ad_Lactation
coxme5 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + AvgMY60 + (1|FarmNo), data=survival)
coxme5

#######################
##    FINAL MODEL    ##
#######################
coxme8 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + ad_Lactation + PeakDFC:ad_Lactation + PeakDFC + AvgMY60 + (1|FarmNo), data=survival)
coxme8

coxme6 <- coxme(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + I(PeakDFC/7) + AvgMY60 + (1|FarmNo), data=survival)
coxme6

cox6 <- coxph(Surv(DaysToFirstIns, FirstAI)~AvgKeto20_100 + I(PeakDFC/7) + AvgMY60, data=survival)

anova(coxme8, coxme6)
anova(cox6, coxme6)

ggforest(cox6, data = survival)
```

### Martingale residuals: check linearity
```{r}
##########################
##      FINAL MODEL     ##
##########################
# check AvgKeto20_100 in coxme6
coxme6 <- coxme(Surv(DaysToFirstIns, FirstAI) ~ AvgKeto20_100 + I(PeakDFC/7) + AvgMY60 + (1|FarmNo), data=survival)
coxme6

me6.keto <- coxme(Surv(DaysToFirstIns, FirstAI) ~ I(PeakDFC/7) + AvgMY60 + (1|FarmNo), data=survival)
res.keto <- resid(me6.keto, type = "martingale")
plot(survival$AvgKeto20_100, res.keto, main = "Residual of AvgKeto20_100 (first AI)")
lines(lowess(survival$AvgKeto20_100, res.keto), col = "red")

me6.PEAK <- coxme(Surv(DaysToFirstIns, FirstAI) ~ AvgKeto20_100 + AvgMY60 + (1|FarmNo), data=survival)
res.PEAK <- resid(me6.PEAK, type = "martingale")
plot(survival$PeakDFC, res.PEAK, main = "Residual of PeakDFC (first AI)")
lines(lowess(survival$PeakDFC, res.PEAK), col = "red")

me6.MY <- coxme(Surv(DaysToFirstIns, FirstAI) ~ AvgKeto20_100 + I(PeakDFC/7) + (1|FarmNo), data=survival)
res.MY <- resid(me6.MY, type = "martingale")
plot(survival$AvgMY60, res.MY, main = "Residual of AvgMY60 (first AI)")
lines(lowess(survival$AvgMY60, res.MY), col = "red")
```

```{r}
print(coxme.fit6.I <- cox.zph(coxme6, transform = "identity"))
print(coxme.fit6.KM <- cox.zph(coxme6, transform = "km"))
print(coxme.fit6.L <- cox.zph(coxme6, transform = "log"))
par(mfrow = c(1,3))
plot(coxme.fit6.I)
plot(coxme.fit6.KM)
plot(coxme.fit6.L)
```

```{r}
## First AI


ggsurvplot(survfit(df.cox1.ai), data = survival, color= "#2E9FDF", ggtheme = theme_minimal())
```
